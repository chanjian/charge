{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 警告消息容器 -->
    <div id="alertContainer"></div>

    <div class="row">
        <!-- 左侧表格区域 -->
        <div class="col-md-8">
            <!-- 当前管理员出库其他圈子的表格 -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-share-square"></i> 当前圈子出库其他圈子的详情</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>对方管理员</th>
                                    <th>订单金额</th>
                                    <th>服务费</th>
                                    <th>应收款</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in self_out_other_object %}
                                <tr cid="{{ item.id }}">
                                    <td>{{ item.lender.username }}</td>
                                    <td>¥{{ item.payment|default:"0.00" }}</td>
                                    <td>¥{{ item.crossfee_amount|default:"0.00" }}</td>
                                    <td class="font-weight-bold">¥{{ item.final_payment|default:"0.00" }}</td>
                                    <td>
                                        <input cid="{{ item.id }}" type="button" class="btn btn-primary btn-xs  btn-clear" value="清除">
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="far fa-folder-open fa-2x"></i>
                                        <p class="mt-2">暂无出库记录</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 其他圈子出库当前管理员的表格 -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-inbox"></i> 其他圈子出库当前圈子的详情</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>对方管理员</th>
                                    <th>订单金额</th>
                                    <th>服务费</th>
                                    <th>应收款</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in other_out_self_object %}
                                <tr cid="{{ item.id }}">
                                    <td>{{ item.borrower.username }}</td>
                                    <td>¥{{ item.payment|default:"0.00" }}</td>
                                    <td>¥{{ item.crossfee_amount|default:"0.00" }}</td>
                                    <td class="font-weight-bold">¥{{ item.final_payment|default:"0.00" }}</td>
                                    <td>

                                        <input cid="{{ item.id }}" type="button" class="btn btn-primary btn-xs btn-clear" value="清除">
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="far fa-folder-open fa-2x"></i>
                                        <p class="mt-2">暂无入库记录</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧操作记录区域 -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-secondary text-white">
                    <h5><i class="fas fa-history"></i> 操作记录</h5>
                </div>
                <div class="card-body p-0">
                    <div class="p-3" style="max-height: 800px; overflow-y: auto;">
                        {% if operation_logs %}
                        <ul class="list-group list-group-flush">
                            {% for log in operation_logs %}
                            <li class="list-group-item py-2">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">{{ log.timestamp|date:"m-d H:i" }}</small>
                                    <span class="badge badge-{% if log.action_type == 'CLEAR' %}danger{% else %}info{% endif %}">
                                        {{ log.get_action_type_display }}
                                    </span>
                                </div>
                                <div class="mt-1">{{ log.action }}</div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="far fa-clock fa-2x"></i>
                            <p class="mt-2">暂无操作记录</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 清空确认模态框 -->
<!--<div class="modal fade" id="clearModal" tabindex="-1" role="dialog" aria-hidden="true">-->
<!--    <div class="modal-dialog modal-dialog-centered" role="document">-->
<!--        <div class="modal-content">-->
<!--            <div class="modal-header">-->
<!--                <h5 class="modal-title"><i class="fas fa-exclamation-circle text-warning"></i> 确认清空</h5>-->
<!--                <button type="button" class="close" data-dismiss="modal" aria-label="Close">-->
<!--                    <span aria-hidden="true">&times;</span>-->
<!--                </button>-->
<!--            </div>-->
<!--            <div class="modal-body">-->
<!--                <p>确认要清空与 <strong id="targetAdminName" class="text-primary"></strong> 的应收账款吗？</p>-->
<!--                <p class="text-muted small">此操作将记录在操作历史中且不可撤销。</p>-->
<!--            </div>-->
<!--            <div class="modal-footer">-->
<!--                <button type="button" class="btn btn-secondary" data-dismiss="modal">-->
<!--                    <i class="fas fa-times"></i> 取消-->
<!--                </button>-->
<!--                <button type="button" class="btn btn-primary" id="confirmClear">-->
<!--                    <i class="fas fa-check"></i> 确认清空-->
<!--                </button>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->


<div class="modal fade" id="clearModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">

    <div class="alert alert-danger alert-dismissible fade in" role="alert">

      <h4>是否确定要删除！</h4>
      <p>
        <button type="button" class="btn btn-danger" id="btnConfirmClear">确 定</button>
        <button type="button" class="btn btn-default" id="btnCancelClear">取 消</button>
          <span style="color: red" id="clearError"></span>
      </p>
    </div>

  </div>
</div>

{% endblock %}

{% block js %}

<script>
    var CLEAR_ID
    $(function (){
        bindClearEvent();
        bindConfirmClearEvent();
    })

    function bindClearEvent(){
        $('.btn-clear').click(function (){
            $("#clearError").empty();

            $('#clearModal').modal('show');
            var cid = $(this).attr('cid')
            CLEAR_ID = cid
            console.log(cid);
        })

        $('#btnCancelClear').click(function (){
            $('#clearModal').modal('hide');
        })
    }

    function bindConfirmClearEvent(){
        $('#btnConfirmClear').click(function (){
           console.log("确认删除!",CLEAR_ID) ;

           $.ajax({
               url:'{% url 'crossfee_clear' %}',
               type:'GET',
               data:{cid:CLEAR_ID},
               dataType:'JSON',
               success:function (res){
                   if (res.status){
                       //删除成功
                       //方式一：做页面刷新
                       //location.reload()
                       //方式二：找到当前数据所在行并删除
                       $("tr[row-id='" + CLEAR_ID + "']").remove()
                       $('#clearModal').modal('hide');

                   }else{
                       //删除失败
                       $("#clearError").text(res.detail);
                   }
               }
           })
        });
    }



    function showDelete(){
        $('#clearModal').modal('show');
    }


    setTimeout(function () {
            $(".top-message").addClass('hide');
        }, 5000);

    </script>
{% endblock %}