{% extends 'layout.html' %}
{% load static %}

{% block css %}
<style>
    .chart-container {
        height: 400px;
        min-width: 300px;
    }
    .panel-heading .pull-right {
        margin-top: -5px;
    }
    .date-filter {
        margin-bottom: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 日期筛选表单 -->
     <!-- 日期筛选表单 -->
    <div class="left">
        <form method="get" class="form-inline" style="margin-bottom: 20px;">
            <!-- 隐藏字段保持当前date_field -->
            <input type="hidden" name="date_field" value="{{ request.GET.date_field|default:'created_time' }}">

            <!-- 时间字段选择 -->
            <div class="form-group">
                <label class="control-label">时间字段</label>
                <select name="date_field" class="form-control" style="width: 120px; margin-left: 5px;"
                        onchange="this.form.submit()">
                    <option value="created_time" {% if request.GET.date_field == 'created_time' %}selected{% endif %}>创建时间</option>
                    <option value="updated_time" {% if request.GET.date_field == 'updated_time' %}selected{% endif %}>更新时间</option>
                    <option value="finished_time" {% if request.GET.date_field == 'finished_time' %}selected{% endif %}>结束时间</option>
                </select>
            </div>

            <!-- 日期范围 -->
            <div class="form-group">
                <label class="control-label">开始日期</label>
                <input type="date" class="form-control" name="start_date"
                       value="{{ start_date }}">
            </div>

            <div class="form-group" style="margin-left: 10px;">
                <label class="control-label">结束日期</label>
                <input type="date" class="form-control" name="end_date"
                       value="{{ end_date }}">
            </div>

            <!-- 操作按钮 -->
            <div class="form-group" style="margin-left: 10px;">
                <button type="submit" class="btn btn-primary">筛选</button>
                <a href="?" class="btn btn-default" style="margin-left: 5px;">重置</a>
            </div>


            <!-- 快捷筛选（保持为链接但携带所有参数） -->
            <div class="form-group" style="margin-left: 20px;">
                <label class="control-label">快捷筛选</label>
                <!-- 近3天 - 不需要传递start_date和end_date，days_range会自动计算 -->
                <a href="?date_field={{ request.GET.date_field|default:'created_time' }}&days_range=3"
                   class="btn btn-default {% if request.GET.days_range == '3' %}active{% endif %}">近3天</a>
                <!-- 近一周 -->
                <a href="?date_field={{ request.GET.date_field|default:'created_time' }}&days_range=7"
                   class="btn btn-default {% if request.GET.days_range == '7' %}active{% endif %}">近一周</a>
                <!-- 近一月 -->
                <a href="?date_field={{ request.GET.date_field|default:'created_time' }}&days_range=30"
                   class="btn btn-default {% if request.GET.days_range == '30' %}active{% endif %}">近一月</a>
            </div>
        </form>
    </div>


    <!-- 第一行：交易流水 -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    交易流水趋势
                    <div class="pull-right">
                        <select id="barChartType" class="form-control input-sm" style="width:100px;">
                            <option value="bar">柱状图</option>
                            <option value="line">折线图</option>
                        </select>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="chartBar" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>


<!-- 消费者消费统计图表 -->
    <div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">消费者消费统计</div>
            <div class="panel-body">
                <div id="chartConsumer" class="chart-container"></div>
                <div id="orderDetails" style="margin-top: 20px; display: none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>消费者</th>
                                <th>订单号</th>
                                <th>创建时间</th>
                                <th>完成时间</th>
                                <th>订单面额</th>
                                <th>折扣(%)</th>
                                <th>实际支付</th>
                            </tr>
                        </thead>
                        <tbody id="orderDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


    <!-- 新增供应商统计 -->
<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">供应商统计</div>
            <div class="panel-body">
                <div id="chartSupplier" class="chart-container"></div>
                <div id="supplierDetails" style="margin-top: 20px; display: none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>供应商</th>
                                <th>订单号</th>
                                <th>创建时间</th>
                                <th>完成时间</th>
                                <th>垫付金额</th>
                                <th>面额</th>
                            </tr>
                        </thead>
                        <tbody id="supplierDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增客服统计 -->
<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">客服统计</div>
            <div class="panel-body">
                <div id="chartSupport" class="chart-container"></div>
                <div id="supportDetails" style="margin-top: 20px; display: none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>客服</th>
                                <th>订单号</th>
                                <th>创建时间</th>
                                <th>垫付金额</th>
                                <th>提成金额</th>
                                <th>面额</th>
                            </tr>
                        </thead>
                        <tbody id="supportDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


</div>
{% endblock %}

{% block js %}
<script src="{% static 'js/echarts.js' %}"></script>
<script>
// 全局图表实例
var chartInstances = {};

// 初始化所有图表
function initCharts() {
    initBarChart();
    initConsumerChart();  // 新增
    initSupplierChart();  // 新增
    initSupportChart();   // 新增




    // 监听窗口变化自动调整图表大小
    $(window).on('resize', function() {
        $.each(chartInstances, function(_, chart) {
            chart.resize();
        });
    });
}

// 获取查询参数
function getQueryParams() {
    return {
        date_field: $('[name="date_field"]').val(),
        start_date: $('[name="start_date"]').val(),
        end_date: $('[name="end_date"]').val()
    };
}

//显示加载动画
function showLoading(chart) {
    chart.showLoading('default', {
        text: '数据加载中...',
        color: '#c23531',
        textColor: '#333',
        maskColor: 'rgba(255, 255, 255, 0.8)',
        zlevel: 0
    });
}

// 隐藏加载动画
function hideLoading(chart) {
    chart.hideLoading();
}

// 显示错误信息
function showError(chart, message) {
    chart.setOption({
        graphic: {
            elements: [{
                type: 'text',
                left: 'center',
                top: 'middle',
                style: {
                    text: message,
                    fontSize: 16,
                    fontWeight: 'bold',
                    fill: '#ff4d4f'
                }
            }]
        }
    });
}

// 初始化页面
$(document).ready(function() {
    initCharts();

    // 表单提交时刷新图表
    $('form').on('submit', function(e) {
        e.preventDefault();
        initCharts();
        return false;
    });
});



function initBarChart() {
    const chartDom = document.getElementById('chartBar');
    if (!chartDom) {
        console.error('错误: 找不到图表容器 #chartBar');
        return;
    }
    chartInstances.barChart = echarts.init(chartDom);

    // 初始化默认配置
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' }
        },
        legend: {
            data: [] // 初始为空，从后端获取
        },
        toolbox: {
                    feature: {
                        saveAsImage: {}
                    }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: [] // 初始为空，从后端获取
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: '{value} 元'
            }
        },
        series: [] // 初始为空，从后端获取
    };

    // 显示加载动画
    showLoading(chartInstances.barChart);

    // 使用AJAX获取数据
    $.ajax({
        url: '{% url "chart_bar" %}',
        type: 'GET',
        dataType: 'JSON',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chartInstances.barChart, response.error || '数据加载失败');

                return;
            }

            // 更新图表配置
            option.legend.data = response.data.series.map(item => item.name);
            option.xAxis.data = response.data.x_axis;
            option.series = response.data.series;

            // 设置图表选项
            chartInstances.barChart.setOption(option);
            hideLoading(chartInstances.barChart);
        },
        error: function(xhr, status, error) {
            showError(chartInstances.barChart, '数据加载失败: ' + error);
            console.log("完整错误响应:", xhr.responseText);
        // 然后你可以复制完整的错误信息
        },
        complete: function() {
            // 无论成功失败都隐藏加载动画（如果之前没隐藏）
            hideLoading(chartInstances.barChart);
        }
    });
}

    // 切换图表类型
    $('#barChartType').change(function() {
        const type = $(this).val();
        const option = chartInstances.barChart.getOption();
        option.series.forEach(series => {
            series.type = type;
        });
        chartInstances.barChart.setOption(option);
    });


function initConsumerChart() {
    const chartDom = document.getElementById('chartConsumer');
    if (!chartDom) return;

    const chart = echarts.init(chartDom);
    chartInstances.consumerChart = chart;

    showLoading(chart);

    $.ajax({
        url: '{% url "chart_consumer" %}',
        type: 'GET',
        dataType: 'JSON',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chart, response.error || '数据加载失败');
                console.error("错误响应:", response);
                return;
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {type: 'shadow'}
                },
                legend: {
                    data: response.data.series.map(item => item.name),
                    type: 'scroll',
                    orient: 'horizontal',
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.x_axis
                },
                yAxis: {
                    type: 'value',
                    name: '实际支付金额(元)'
                },
                series: response.data.series
            };

            chart.setOption(option);
            hideLoading(chart);

            // 存储订单详情数据
            chart._orderDetails = response.data.order_details;

            // 添加点击事件
            chart.on('click', function(params) {
                showOrderDetails(params);
            });
        },
        error: function(xhr) {
            showError(chart, '请求失败');
            console.error("请求错误:", xhr.responseText);
            hideLoading(chart);
        }
    });
}

// 显示消费者订单详情
function showOrderDetails(params) {
    if (!params || !params.seriesName || !params.name) return;

    const details = chartInstances.consumerChart._orderDetails[params.name];
    if (!details) return;

    const $tbody = $('#orderDetailsBody');
    $tbody.empty();

    // 过滤出当前消费者的订单
    const consumerOrders = details.filter(
        order => order.consumer === params.seriesName
    );

    consumerOrders.forEach(order => {
        const formatTime = (timeStr) => {
        if (!timeStr) return 'N/A';
        const date = new Date(timeStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).replace(/\//g, '-');
    };

        $tbody.append(`
            <tr>
                <td>${order.consumer}</td>
                <td>${order.order_number}</td>
                <td>${formatTime(order.created_time)}</td>
                <td>${formatTime(order.finished_time)}</td>
                <td>${order.amount.toFixed(2)}</td>
                <td>${order.discount}</td>
                <td>${order.final_price.toFixed(2)}</td>
            </tr>
        `);
    });

    $('#orderDetails').show();
}



// 初始化供应商图表
function initSupplierChart() {
    const chartDom = document.getElementById('chartSupplier');
    if (!chartDom) return;

    const chart = echarts.init(chartDom);
    chartInstances.supplierChart = chart;
    showLoading(chart);

    $.ajax({
        url: '{% url "chart_supplier" %}',
        type: 'GET',
        dataType: 'JSON',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chart, response.error || '数据加载失败');
                return;
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {type: 'shadow'}
                },
                legend: {
                    data: response.data.series.map(item => item.name),
                    type: 'scroll',
                    orient: 'horizontal',
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.x_axis
                },
                yAxis: {
                    type: 'value',
                    name: '金额(元)'
                },
                series: response.data.series
            };

            chart.setOption(option);
            chart._orderDetails = response.data.order_details;

            chart.on('click', function(params) {
                const details = chart._orderDetails[params.name];
                const $tbody = $('#supplierDetailsBody');
                $tbody.empty();

                details.filter(d => d.supplier === params.seriesName).forEach(order => {
                    $tbody.append(`
                        <tr>
                            <td>${order.supplier}</td>
                            <td>${order.order_number}</td>
                            <td>${order.created_time}</td>
                            <td>${order.finished_time}</td>
                            <td>${order.supplier_payment.toFixed(2)}</td>
                            <td>${order.amount.toFixed(2)}</td>
                        </tr>
                    `);
                });
                $('#supplierDetails').show();
            });
        }
    });
}

// 初始化客服图表
function initSupportChart() {
    const chartDom = document.getElementById('chartSupport');
    if (!chartDom) return;

    const chart = echarts.init(chartDom);
    chartInstances.supportChart = chart;
    showLoading(chart);

    $.ajax({
        url: '{% url "chart_support" %}',
        type: 'GET',
        dataType: 'JSON',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chart, response.error || '数据加载失败');
                return;
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {type: 'shadow'}
                },
                legend: {
                    data: response.data.series.map(item => item.name),
                    type: 'scroll',
                    orient: 'horizontal',
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.x_axis
                },
                yAxis: {
                    type: 'value',
                    name: '金额(元)'
                },
                series: response.data.series
            };

            chart.setOption(option);
            chart._orderDetails = response.data.order_details;

            chart.on('click', function(params) {
                const details = chart._orderDetails[params.name];
                const $tbody = $('#supportDetailsBody');
                $tbody.empty();

                details.filter(d => d.support === params.seriesName).forEach(order => {
                    $tbody.append(`
                        <tr>
                            <td>${order.support}</td>
                            <td>${order.order_number}</td>
                            <td>${order.created_time}</td>
                            <td>${order.support_payment.toFixed(2)}</td>
                            <td>${order.commission.toFixed(2)}</td>
                            <td>${order.amount.toFixed(2)}</td>
                        </tr>
                    `);
                });
                $('#supportDetails').show();
            });
        }
    });
}


</script>
{% endblock %}