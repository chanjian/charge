{% extends 'layout.html' %}
{% load static %}

{% block css %}
<style>
    .chart-container {
        height: 400px;
        min-width: 300px;
    }
    .panel-heading .pull-right {
        margin-top: -5px;
    }
    .date-filter {
        margin-bottom: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 4px;
    }


</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- æ—¥æœŸç­›é€‰è¡¨å• -->
     {% include 'tag/time_filter.html' %}

{% if request.userinfo.usertype in "SUPERADMIN ADMIN" %}
    <!-- ç¬¬ä¸€è¡Œï¼šäº¤æ˜“æµæ°´ -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    äº¤æ˜“æµæ°´è¶‹åŠ¿
                </div>
                <div class="panel-body">
                    <div id="chartBar" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

{% if request.userinfo.usertype in "SUPERADMIN ADMIN CUSTOMER" %}
<!-- æ¶ˆè´¹è€…æ¶ˆè´¹ç»Ÿè®¡å›¾è¡¨ -->
    <div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">æ¶ˆè´¹è€…æ¶ˆè´¹é‡‘é¢ç»Ÿè®¡</div>
            <div class="panel-body">
                <div id="chartConsumer" class="chart-container"></div>
                <div id="consumerDetails" style="margin-top: 20px; display: none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>æ¶ˆè´¹è€…</th>
                                <th>è®¢å•å·</th>
                                <th>è®¢å•åŸä»·</th>
                                <th>å®é™…æ”¯ä»˜ä»·æ ¼</th>
                                <th>æŠ˜æ‰£(%)</th>
                                <th>æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="consumerDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
    {% endif %}

<div class="row">
    {% if request.userinfo.usertype in "SUPERADMIN ADMIN SUPPLIER" %}
    <!-- ä¾›åº”å•†å›¾è¡¨ -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">åº”ç»“ç®—ä¾›åº”å•†è´§æ¬¾ç»Ÿè®¡</div>
            <div class="panel-body">
                <div id="chartSupplier" style="height:400px;"></div>
                <div id="supplierDetails" class="mt-3" style="display:none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>ä¾›åº”å•†åç§°</th>
                                <th>è®¢å•å·</th>
                                <th>è®¢å•åŸä»·</th>
                                <th>åº”ä»˜ä¾›åº”å•†è´¦æ¬¾é‡‘é¢</th>
                                <th>æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="supplierDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
      {% endif %}

      {% if request.userinfo.usertype in "SUPERADMIN ADMIN SUPPORT" %}
    <!-- å®¢æœå›¾è¡¨ -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">åº”ç»“ç®—å®¢æœè´¦æ¬¾ç»Ÿè®¡</div>
            <div class="panel-body">
                <div id="chartSupport" style="height:400px;"></div>
                <div id="supportDetails" class="mt-3" style="display:none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>å®¢æœåç§°</th>
                                <th>è®¢å•å·</th>
                                <th>è®¢å•åŸä»·</th>
                                <th>å®¢æœå«ä»˜é‡‘é¢</th>
                                <th>ææˆ</th>
                                <th>åº”ä»˜å®¢æœè´¦æ¬¾é‡‘é¢</th>
                                <th>æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="supportDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}


    {% if request.userinfo.usertype in "SUPERADMIN ADMIN" %}
    <!-- åœ¨dashboard_list.htmlçš„é€‚å½“ä½ç½®æ·»åŠ  -->
<div class="row">
    <!-- æœ¬åœˆå‡ºåº“å…¶ä»–åœˆå­è®¢å• -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                æœ¬åœˆå‡ºåº“å…¶ä»–åœˆå­è®¢å•
                <div class="pull-right">
                    <small>åº”æ”¶æ¬¾ç»Ÿè®¡</small>
                </div>
            </div>
            <div class="panel-body">
                <div id="chartSelfOutOther" class="chart-container" style="height:400px;"></div>
                <div id="selfOutOtherDetails" style="display:none;margin-top:20px">
                    <table class="table table-bordered table-hover">
                        <thead>
                        <tr>
                            <th>å…¥åº“æ–¹ç®¡äº‹äºº</th>
                            <th>ç±»å‹</th>
                            <th>è®¢å•å·</th>
                            <th>åŸä»·</th>
                            <th>å®é™…æ”¯ä»˜ä»·æ ¼</th>
                            <th>è·¨åœˆè´¹</th>
                            <th>æœ€ç»ˆåº”æ”¶æ¬¾</th>
                            <th>æ¶ˆè´¹è€…</th>
                            <th>çŠ¶æ€</th>
                            <th>æ—¶é—´</th>
                        </tr>
                        </thead>
                        <tbody id="selfOutOtherDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¶ä»–åœˆå­å‡ºåº“æœ¬åœˆè®¢å• -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                å…¶ä»–åœˆå­å‡ºåº“æœ¬åœˆè®¢å•
                <div class="pull-right">
                    <small>åº”ä»˜æ¬¾ç»Ÿè®¡</small>
                </div>
            </div>
            <div class="panel-body">
                <div id="chartOtherOutSelf" class="chart-container" style="height:400px;"></div>
                <div id="otherOutSelfDetails" style="display:none;margin-top:20px">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>å‡ºåº“æ–¹</th>
                                <th>ç±»å‹</th>
                                <th>è®¢å•å·</th>
                                <th>åŸä»·</th>
                                <th>å®é™…æ”¯ä»˜ä»·æ ¼</th>
                                <th>è·¨åœˆè´¹</th>
                                <th>æœ€ç»ˆåº”æ”¯ä»˜</th>
                                <th>æ¶ˆè´¹è€…</th>
                                <th>çŠ¶æ€</th>
                                <th>æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="otherOutSelfDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>
    {% endif %}

</div>
{% endblock %}

{% block js %}
<script src="{% static 'js/echarts.js' %}"></script>
<script>
// å…¨å±€å›¾è¡¨å®ä¾‹
var chartInstances = {};

//åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
function initCharts() {
    initBarChart();
    initConsumerChart();  // æ–°å¢
    initSupplierChart();  // æ–°å¢
    initSupportChart();   // æ–°å¢
    initOtherOutSelfChart();
    initSelfOutOtherChart();

    // ç›‘å¬çª—å£å˜åŒ–è‡ªåŠ¨è°ƒæ•´å›¾è¡¨å¤§å°
    $(window).on('resize', function() {
        $.each(chartInstances, function(_, chart) {
            chart.resize();
        });
    });
}

// è·å–æŸ¥è¯¢å‚æ•°
function getQueryParams() {
    return {
        date_field: $('[name="date_field"]').val(),
        start_date: $('[name="start_date_str"]').val(),
        end_date: $('[name="end_date_str"]').val()
    };
}

//æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
function showLoading(chart) {
    chart.showLoading('default', {
        text: 'æ•°æ®åŠ è½½ä¸­...',
        color: '#c23531',
        textColor: '#333',
        maskColor: 'rgba(255, 255, 255, 0.8)',
        zlevel: 0
    });
}

// éšè—åŠ è½½åŠ¨ç”»
function hideLoading(chart) {
    chart.hideLoading();
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(chart, message) {
    chart.setOption({
        graphic: {
            elements: [{
                type: 'text',
                left: 'center',
                top: 'middle',
                style: {
                    text: message,
                    fontSize: 16,
                    fontWeight: 'bold',
                    fill: '#ff4d4f'
                }
            }]
        }
    });

    chart.hideLoading();

    // æ¸…é™¤ç°æœ‰å†…å®¹
    chart.clear();

    // æ·»åŠ é”™è¯¯æç¤º
    chart.getDom().innerHTML += `
        <div class="echarts-error-message">
            <div style="font-size:16px;margin-bottom:10px">ğŸ˜¢ å›¾è¡¨åŠ è½½å¤±è´¥</div>
            <div style="color:#666;font-size:14px">${message}</div>
        </div>
    `;

    console.error(`å›¾è¡¨é”™è¯¯: ${message}`);
}

// åˆå§‹åŒ–é¡µé¢
$(document).ready(function() {
    initCharts();

    // è¡¨å•æäº¤æ—¶åˆ·æ–°å›¾è¡¨
    $('form').on('submit', function(e) {
        e.preventDefault();
        initCharts();
        return false;
    });
});


function initBarChart() {
    const chartDom = document.getElementById('chartBar');
    if (!chartDom) return console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨ chartBar');

    const chart = echarts.init(chartDom);
    chartInstances.barChart = chart;
    chart.showLoading();

    $.ajax({
        url: '{% url "chart_bar" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) return showError(chart, response.error || 'åŠ è½½æ•°æ®å¤±è´¥');

            const option = {
                title: {
                    text: `äº¤æ˜“æµæ°´ç»Ÿè®¡ (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const seriesName = params.seriesName;
                        const value = params.value;
                        const stats = response.data.total_stats;

                        let html = `<div style="font-weight:bold;margin-bottom:8px;">
                            ${response.data.date_range} æ±‡æ€»æ•°æ®</div>`;

                        html += `<div style="margin:5px 0;">
                            <span style="display:inline-block;width:12px;height:12px;
                                background:${params.color};margin-right:8px;"></span>
                            <strong>${seriesName}:</strong> ${value}
                            ${seriesName.includes('è®¢å•')? 'ç¬”' : 'å…ƒ'}
                        </div>`;

                        // æ·»åŠ ç›¸å…³ç»Ÿè®¡ä¿¡æ¯
                        if (seriesName === 'æ€»åˆ©æ¶¦') {
                            html += `<div style="margin-top:10px;color:#555">
                                <div>æ€»æµæ°´: ${stats.total_amount.toFixed(2)}å…ƒ</div>
                                <div>ç³»ç»Ÿè´¹: ${stats.system_fee.toFixed(2)}å…ƒ</div>
                                <div>ä¸‰æ–¹å€Ÿè°ƒè´¹: ${stats.cross_fee.toFixed(2)}å…ƒ</div>
                                <div>æ€»æ”¯å‡º: ${(stats.support_payment + stats.supplier_payment + stats.admin_payment).toFixed(2)}å…ƒ</div>
                            </div>`;
                        }

                        return html;
                    }
                },
                legend: {
                    data: response.data.series.map(s => s.name),
                    bottom: 0,
                    // type:'scroll',
                    padding: [5, 50],
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                        saveAsImage: {}
                    }
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: { show: false }  // éšè—æ—¥æœŸæ ‡ç­¾ï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¾ç¤ºä¸€ä¸ªæ±‡æ€»æŸ±çŠ¶å›¾
                },
                yAxis: {
                    type: 'value',
                    // åœ¨è¿™é‡Œè·å– seriesNameï¼Œç¡®ä¿å®ƒåœ¨è¿™ä¸ªä½œç”¨åŸŸå†…æœ‰å®šä¹‰
                    name: response.data.series.length > 0? (response.data.series[0].name.includes('è®¢å•')? 'æ•°é‡(ç¬”)' : 'é‡‘é¢(å…ƒ)') : ''
                },
                series: response.data.series.map(s => ({
                   ...s,
                    barWidth: 60,  // å›ºå®šå®½åº¦
                    label: {
        show: true,
        position: 'top', // æ•°å­—æ˜¾ç¤ºåœ¨æŸ±å­é¡¶éƒ¨
        formatter: '{c}', // åªæ˜¾ç¤ºæ•°å€¼ï¼Œå¯æ”¹ä¸º '{c} å…ƒ' å¸¦å•ä½
        color: '#333', // æ–‡å­—é¢œè‰²
        fontSize: 12, // å­—ä½“å¤§å°
    }
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // ç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºæ‰€æœ‰è®¢å•è¯¦æƒ…
            chart.on('click', function(params) {
                const details = response.data.tooltip_data["æ±‡æ€»"] || [];

                const $tbody = $('#barChartDetailsBody').empty();
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="10" class="text-center">æ— è®¢å•è¯¦æƒ…</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`<tr>
                            <td>${item.order_number}</td>
                            <td>${item.out_admin}</td>
                            <td>${item.out_admin_type}</td>
                            <td>${item.original_amount.toFixed(2)}å…ƒ</td>
                            <td>${item.final_price.toFixed(2)}å…ƒ</td>
                            <td>${item.system_fee.toFixed(2)}å…ƒ</td>
                            <td>${item.cross_fee.toFixed(2)}å…ƒ</td>
                            <td><strong style="color:${item.profit >= 0? '#52c41a' : '#f5222d'}">
                                ${item.profit.toFixed(2)}å…ƒ</strong></td>
                            <td>${item.consumer}</td>
                            <td>${item.time}</td>
                        </tr>`);
                    });
                }
                $("#barChartDetails").show();
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, 'è¯·æ±‚å¤±è´¥:'+ xhr.statusText);
        }
    });
}





// ä¿®æ”¹åçš„æ¶ˆè´¹è€…å›¾è¡¨å‡½æ•°ï¼ˆå®Œæ•´ç‰ˆï¼‰
function initConsumerChart() {
    const chartDom = document.getElementById('chartConsumer');
    if (!chartDom) return console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨');

    const chart = echarts.init(chartDom);
    chartInstances.consumerChart = chart;
    chart.showLoading();

    // ä¿å­˜ä¸Šæ¬¡ç‚¹å‡»çš„æ¶ˆè´¹è€…åç§°
    let lastClickedConsumer = null;

    $.ajax({
        url: '{% url "chart_consumer" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) return showError(chart, response.error || 'åŠ è½½æ•°æ®å¤±è´¥');

            const option = {
                title: {
                    text: `æ¶ˆè´¹è€…æ¶ˆè´¹ç»Ÿè®¡ (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const consumer = params.seriesName;
                        const data = response.data.tooltip_data["æ±‡æ€»"][consumer] || {};

                        return `
                            <div style="font-weight:bold;margin-bottom:8px;">
                                ${response.data.date_range} æ±‡æ€»æ•°æ®
                            </div>
                            <div style="margin:8px 0;">
                                <span style="display:inline-block;width:12px;height:12px;
                                    background:${params.color};margin-right:8px;"></span>
                                <strong>${consumer}</strong>
                            </div>
                            <div style="margin-left:20px;color:#555">
                                <div>è®¢å•æ•°: <b>${data.order_count || 0}ç¬”</b></div>
                                <div style="color:#722ed1">æ¶ˆè´¹é‡‘é¢æ€»è®¡: ${(data.total_consumption || 0).toFixed(2)}å…ƒ</div>
                            </div>
                        `;
                    }
                },
                legend: {
                    data: response.data.consumers,
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: { rotate: 0 },
                    show: false,
                },
                yAxis: {
                    type: 'value',
                    name: 'æ¶ˆè´¹é‡‘é¢(å…ƒ)'
                },
                series: response.data.series.map(series => ({
                    ...series,
                    barWidth: 40
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // ç‚¹å‡»äº‹ä»¶å¤„ç†
            chart.on('click', function(params) {
                const currentConsumer = params.seriesName;
                const details = response.data.tooltip_data["æ±‡æ€»"][currentConsumer]?.orders || [];
                const $tbody = $('#consumerDetailsBody').empty();

                // å¡«å……è¡¨æ ¼æ•°æ®
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="6" class="text-center">æ— è®¢å•è¯¦æƒ…</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`
                            <tr>
                                <td>${currentConsumer}</td>
                                <td>${item.order_number}</td>
                                <td>${item.original_amount.toFixed(2)}å…ƒ</td>
                                <td style="color:#ff4d4f; font-weight: bold">${item.final_price.toFixed(2)}å…ƒ</td>
                                <td>${item.consumer_level}%</td>
                                <td>${item.created_time || 'æœªçŸ¥æ—¶é—´'}</td>
                            </tr>
                        `);
                    });
                }

                // å¤„ç†è¡¨æ ¼æ˜¾ç¤ºé€»è¾‘
                if (lastClickedConsumer === currentConsumer) {
                    // ç‚¹å‡»çš„æ˜¯åŒä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                    $("#consumerDetails").toggle();
                } else {
                    // ç‚¹å‡»çš„æ˜¯ä¸åŒæ¶ˆè´¹è€…ï¼Œæ˜¾ç¤ºæ–°è¡¨æ ¼
                    $("#consumerDetails").show();
                    lastClickedConsumer = currentConsumer;
                }
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, 'è¯·æ±‚å¤±è´¥: ' + xhr.statusText);
        }
    });
}



// ä¿®æ”¹åçš„ä¾›åº”å•†å›¾è¡¨å‡½æ•°ï¼ˆå®Œæ•´ç‰ˆï¼‰
function initSupplierChart() {
    const chartDom = document.getElementById('chartSupplier');
    if (!chartDom) return console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨');

    const chart = echarts.init(chartDom);
    chartInstances.supplierChart = chart;
    chart.showLoading();

    // ä¿å­˜ä¸Šæ¬¡ç‚¹å‡»çš„ä¾›åº”å•†åç§°
    let lastClickedSupplier = null;

    $.ajax({
        url: '{% url "chart_supplier" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) return showError(chart, response.error || 'åŠ è½½æ•°æ®å¤±è´¥');

            const option = {
                title: {
                    text: `ä¾›åº”å•†ç»“ç®—ç»Ÿè®¡ (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const supplier = params.seriesName;
                        const data = response.data.tooltip_data["æ±‡æ€»"][supplier] || {};

                        return `
                            <div style="font-weight:bold;margin-bottom:8px;">
                                ${response.data.date_range} æ±‡æ€»æ•°æ®
                            </div>
                            <div style="margin:8px 0;">
                                <span style="display:inline-block;width:12px;height:12px;
                                    background:${params.color};margin-right:8px;"></span>
                                <strong>${supplier}</strong>
                            </div>
                            <div style="margin-left:20px;color:#555">
                                <div>å¤„ç†è®¢å•æ•°: <b>${data.order_count || 0}ç¬”</b></div>
                                <div style="color:#1890ff">ç»“ç®—é‡‘é¢æ€»è®¡: ${(data.total_payment || 0).toFixed(2)}å…ƒ</div>
                            </div>
                        `;
                    }
                },
                legend: {
                    data: response.data.suppliers,
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: { rotate: 0 },
                    show: false,
                },
                yAxis: {
                    type: 'value',
                    name: 'ç»“ç®—é‡‘é¢(å…ƒ)'
                },
                series: response.data.series.map(series => ({
                    ...series,
                    barWidth: 40
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // ç‚¹å‡»äº‹ä»¶å¤„ç†
            chart.on('click', function(params) {
                const currentSupplier = params.seriesName;
                const details = response.data.tooltip_data["æ±‡æ€»"][currentSupplier]?.orders || [];
                const $tbody = $('#supplierDetailsBody').empty();

                // å¡«å……è¡¨æ ¼æ•°æ®
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="5" class="text-center">æ— è®¢å•è¯¦æƒ…</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`
                            <tr>
                                <td>${currentSupplier}</td>
                                <td>${item.order_number}</td>
                                <td>${item.amount.toFixed(2)}å…ƒ</td>
                                <td style="color:#ff4d4f; font-weight: bold">${item.payment.toFixed(2)}å…ƒ</td>
                                <td>${item.created_time || 'æœªçŸ¥æ—¶é—´'}</td>
                            </tr>
                        `);
                    });
                }

                // å¤„ç†è¡¨æ ¼æ˜¾ç¤ºé€»è¾‘
                if (lastClickedSupplier === currentSupplier) {
                    // ç‚¹å‡»çš„æ˜¯åŒä¸€ä¸ªä¾›åº”å•†ï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                    $("#supplierDetails").toggle();
                } else {
                    // ç‚¹å‡»çš„æ˜¯ä¸åŒä¾›åº”å•†ï¼Œæ˜¾ç¤ºæ–°è¡¨æ ¼
                    $("#supplierDetails").show();
                    lastClickedSupplier = currentSupplier;
                }
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, 'è¯·æ±‚å¤±è´¥: ' + xhr.statusText);
        }
    });
}

//ä¿®æ”¹åçš„å®¢æœå›¾è¡¨å‡½æ•°ï¼ˆå®Œæ•´ç‰ˆï¼‰
function initSupportChart() {
    const chartDom = document.getElementById('chartSupport');
    if (!chartDom) return console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨');

    const chart = echarts.init(chartDom);
    chartInstances.supportChart = chart;
    chart.showLoading();

    // ä¿å­˜ä¸Šæ¬¡ç‚¹å‡»çš„å®¢æœåç§°
    let lastClickedSupport = null;

    $.ajax({
        url: '{% url "chart_support" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) return showError(chart, response.error || 'åŠ è½½æ•°æ®å¤±è´¥');

            const option = {
                title: {
                    text: `å®¢æœç»Ÿè®¡ (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const support = params.seriesName;
                        const data = response.data.tooltip_data["æ±‡æ€»"][support] || {};

                        return `
                            <div style="font-weight:bold;margin-bottom:8px;">
                                ${response.data.date_range} æ±‡æ€»æ•°æ®
                            </div>
                            <div style="margin:8px 0;">
                                <span style="display:inline-block;width:12px;height:12px;
                                    background:${params.color};margin-right:8px;"></span>
                                <strong>${support}</strong>
                            </div>
                            <div style="margin-left:20px;color:#555">
                                <div>å¤„ç†è®¢å•æ•°: <b>${data.order_count || 0}ç¬”</b></div>
                                <div>å«ä»˜é‡‘é¢æ€»è®¡: ${(data.support_payment || 0).toFixed(2)}å…ƒ</div>
                                <div>ææˆé‡‘é¢æ€»è®¡: ${(data.commission || 0).toFixed(2)}å…ƒ</div>
                                <div style="color:#ff4d4f">æœ€ç»ˆåº”æ”¯ä»˜é‡‘é¢æ€»è®¡: ${(data.final_support_payment || 0).toFixed(2)}å…ƒ</div>
                            </div>
                        `;
                    }
                },
                legend: {
                    data: response.data.supports,
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: { rotate: 0 },
                    show: false,
                },
                yAxis: {
                    type: 'value',
                    name: 'å«ä»˜é‡‘é¢(å…ƒ)'
                },
                series: response.data.series.map(series => ({
                    ...series,
                    barWidth: 40
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // ç‚¹å‡»äº‹ä»¶å¤„ç†
            chart.on('click', function(params) {
                const currentSupport = params.seriesName;
                const details = response.data.tooltip_data["æ±‡æ€»"][currentSupport]?.orders || [];
                const $tbody = $('#supportDetailsBody').empty();

                // å¡«å……è¡¨æ ¼æ•°æ®
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="6" class="text-center">æ— è®¢å•è¯¦æƒ…</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`
                            <tr>
                                <td>${currentSupport}</td>
                                <td>${item.order_number}</td>
                                <td>${item.amount.toFixed(2)}å…ƒ</td>
                                <td style="font-weight: bold">${item.support_payment.toFixed(2)}å…ƒ</td>
                                <td style="font-weight: bold">${item.commission.toFixed(2)}å…ƒ</td>
                                <td style="color:rgba(255,77,79,0.93); font-weight: bold">${item.final_support_payment.toFixed(2)}å…ƒ</td>
                                <td>${item.created_time || 'æœªçŸ¥æ—¶é—´'}</td>
                            </tr>
                        `);
                    });
                }

                // å¤„ç†è¡¨æ ¼æ˜¾ç¤ºé€»è¾‘
                if (lastClickedSupport === currentSupport) {
                    // ç‚¹å‡»çš„æ˜¯åŒä¸€ä¸ªå®¢æœï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                    $("#supportDetails").toggle();
                } else {
                    // ç‚¹å‡»çš„æ˜¯ä¸åŒå®¢æœï¼Œæ˜¾ç¤ºæ–°è¡¨æ ¼
                    $("#supportDetails").show();
                    lastClickedSupport = currentSupport;
                }
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, 'è¯·æ±‚å¤±è´¥: ' + xhr.statusText);
        }
    });
}


function initSelfOutOtherChart() {
    const chartDom = document.getElementById('chartSelfOutOther');
    if (!chartDom) return console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨ chartSelfOutOther');

    const chart = echarts.init(chartDom);
    chartInstances.selfOutOtherChart = chart;
    chart.showLoading();

    // ä¿å­˜ä¸Šæ¬¡ç‚¹å‡»çš„ä¿¡æ¯
    let lastClickedAdmin = null;

    $.ajax({
        url: '{% url "chart_self_out_other" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) return showError(chart, response.error || 'åŠ è½½æ•°æ®å¤±è´¥');

            const option = {
                title: {
                    text: `æœ¬åœˆå‡ºåº“è®¢å•ç»Ÿè®¡ (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const admin = params.seriesName;
                        const data = response.data.tooltip_data["æ±‡æ€»"][admin] || {};

                        return `
                            <div style="font-weight:bold;margin-bottom:8px;">
                                ${response.data.date_range} æ±‡æ€»æ•°æ®
                            </div>
                            <div style="margin:8px 0;">
                                <span style="display:inline-block;width:12px;height:12px;
                                    background:${params.color};margin-right:8px;"></span>
                                <strong>${admin}</strong>
                            </div>
                            <div style="margin-left:20px;color:#555">
                                <div>æ€»è®¢å•æ•°: <b>${data.order_count || 0}ç¬”</b></div>
                                <div>åŸä»·æ€»è®¡: ${(data.original_amount || 0).toFixed(2)}å…ƒ</div>
                                <div>å®é™…æ”¯ä»˜ä»·æ ¼æ€»è®¡: ${(data.receivable || 0).toFixed(2)}å…ƒ</div>
                                <div style="color:#ff4d4f">è·¨åœˆè´¹æ€»è®¡: ${(data.cross_fee || 0).toFixed(2)}å…ƒ</div>
                                <div style="color:#52c41a">åº”æ”¶æ¬¾æ€»è®¡: ${(data.final_receivable || 0).toFixed(2)}å…ƒ</div>
                            </div>
                        `;
                    }
                },
                legend: {
                    data: response.data.admins,
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: { rotate: 0 },
                    show: false,
                },
                yAxis: {
                    type: 'value',
                    name: 'åº”æ”¶æ¬¾é‡‘é¢(å…ƒ)'
                },
                series: response.data.series.map(series => ({
                    ...series,
                    barWidth: 40
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // ç‚¹å‡»äº‹ä»¶å¤„ç†
            chart.on('click', function(params) {
                const currentAdmin = params.seriesName;
                const details = response.data.tooltip_data["æ±‡æ€»"][currentAdmin]?.orders || [];
                const $tbody = $('#selfOutOtherDetailsBody').empty();

                // å¡«å……è¡¨æ ¼æ•°æ®
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="9" class="text-center">æ— è®¢å•è¯¦æƒ…</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`<tr>
                            <td>${item.in_admin}</td>
                            <td>${item.out_admin_type}</td>
                            <td>${item.order_number}</td>
                            <td>${item.original_amount.toFixed(2)}å…ƒ</td>
                            <td>${item.receivable.toFixed(2)}å…ƒ</td>
                            <td>${item.cross_fee.toFixed(2)}å…ƒ</td>
<!--                            <td style="color:rgba(255,77,79,0.93)">${item.final_receivable.toFixed(2)}å…ƒ</td>-->
                            <td><strong style="color:rgba(255,77,79,0.93)">${item.final_receivable.toFixed(2)}å…ƒ</strong></td>
                            <td>${item.consumer}</td>
                            <td>${item.order_status}</td>
                            <td>${item.time}</td>
                        </tr>`);
                    });
                }

                // å¤„ç†è¡¨æ ¼æ˜¾ç¤ºé€»è¾‘
                if (lastClickedAdmin === currentAdmin) {
                    // ç‚¹å‡»çš„æ˜¯åŒä¸€ä¸ªç®¡ç†å‘˜ï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                    $("#selfOutOtherDetails").toggle();
                } else {
                    // ç‚¹å‡»çš„æ˜¯ä¸åŒç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºæ–°è¡¨æ ¼
                    $("#selfOutOtherDetails").show();
                    lastClickedAdmin = currentAdmin;
                }
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, 'è¯·æ±‚å¤±è´¥: ' + xhr.statusText);
        }
    });
}


function initOtherOutSelfChart() {
    const chartDom = document.getElementById('chartOtherOutSelf');
    // æ£€æŸ¥å›¾è¡¨å®¹å™¨æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ‰“å°é”™è¯¯ä¿¡æ¯å¹¶è¿”å›
    if (!chartDom) {
        return console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨ chartOtherOutSelf');
    }

    const chart = echarts.init(chartDom);
    chartInstances.otherOutSelfChart = chart;
    chart.showLoading();

    // ä¿å­˜ä¸Šæ¬¡ç‚¹å‡»çš„ç®¡ç†å‘˜ä¿¡æ¯
    let lastClickedAdmin = null;

    $.ajax({
        url: '{% url "chart_other_out_self" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function (response) {
            // å¦‚æœè¯·æ±‚æ•°æ®å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¹¶è¿”å›
            if (!response.status) {
                return showError(chart, response.error || 'åŠ è½½æ•°æ®å¤±è´¥');
            }

            // æ„å»º ECharts å›¾è¡¨çš„é…ç½®é¡¹
            const option = {
                title: {
                    text: `å¤–éƒ¨å…¥åœˆè®¢å•ç»Ÿè®¡ (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        const admin = params.seriesName;
                        const data = response.data.tooltip_data["æ±‡æ€»"][admin] || {};

                        return `
                            <div style="font-weight:bold;margin-bottom:8px;">
                                ${response.data.date_range} æ±‡æ€»æ•°æ®
                            </div>
                            <div style="margin:8px 0;">
                                <span style="display:inline-block;width:12px;height:12px;
                                    background:${params.color};margin-right:8px;"></span>
                                <strong>${admin}</strong>
                            </div>
                            <div style="margin-left:20px;color:#555">
                                <div>æ€»è®¢å•æ•°: <b>${data.order_count || 0}ç¬”</b></div>
                                <div>åŸä»·æ€»è®¡: ${(data.original_amount || 0).toFixed(2)}å…ƒ</div>
                                <div>å®é™…æ”¯ä»˜ä»·æ ¼æ€»è®¡: ${(data.payment || 0).toFixed(2)}å…ƒ</div>
                                <div style="color:#ff4d4f">è·¨åœˆè´¹æ€»è®¡: ${(data.cross_fee || 0).toFixed(2)}å…ƒ</div>
                                <div style="color:#1890ff">åº”ä»˜æ¬¾æ€»è®¡: ${(data.final_payment || 0).toFixed(2)}å…ƒ</div>

                            </div>
                        `;
                    }
                },
                legend: {
                    data: response.data.admins,
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: {
                        rotate: 0,  // ä¸éœ€è¦æ—‹è½¬
                        show: false  // éšè—xè½´æ ‡ç­¾ï¼ˆå› ä¸ºæŸ±å­å†…éƒ¨å·²æ˜¾ç¤ºï¼‰
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'åº”ä»˜æ¬¾é‡‘é¢(å…ƒ)'
                },
                series: response.data.series.map(series => ({
                   ...series,
                    barWidth: 40,  // å›ºå®šå®½åº¦
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
            chart.on('click', function (params) {
                const admin = params.seriesName;
                const details = response.data.tooltip_data["æ±‡æ€»"][admin]?.orders || [];

                const $tbody = $('#otherOutSelfDetailsBody').empty();
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="9" class="text-center">æ— è®¢å•è¯¦æƒ…</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`<tr>
                            <td>${item.out_admin}</td>
                            <td>${item.out_admin_type}</td>
                            <td>${item.order_number}</td>
                            <td>${item.original_amount.toFixed(2)}å…ƒ</td>
                            <td>${item.payment.toFixed(2)}å…ƒ</td>
                            <td>${item.cross_fee.toFixed(2)}å…ƒ</td>
                            <td><strong style="color:rgba(255,77,79,0.93)">${item.final_payment.toFixed(2)}å…ƒ</strong></td>
                            <td>${item.consumer}</td>
                            <td>${item.order_status}</td>
                            <td>${item.time}</td>
                        </tr>`);
                    });
                }
                // å¤„ç†è¡¨æ ¼æ˜¾ç¤ºé€»è¾‘
                if (lastClickedAdmin === admin) {
                    // ç‚¹å‡»çš„æ˜¯åŒä¸€ä¸ªç®¡ç†å‘˜ï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                    $("#otherOutSelfDetails").toggle();
                } else {
                    // ç‚¹å‡»çš„æ˜¯ä¸åŒç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºæ–°è¡¨æ ¼
                    $("#otherOutSelfDetails").show();
                    lastClickedAdmin = admin;
                }
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function (xhr) {
            showError(chart, 'è¯·æ±‚å¤±è´¥:'+ xhr.statusText);
        }
    });
}


//åˆå§‹åŒ–æœ¬åœˆå‡ºåº“å…¶ä»–åœˆå­è®¢å•å›¾è¡¨



// function initOtherOutSelfChart() {
//     const chartDom = document.getElementById('chartOtherOutSelf');
//     if (!chartDom) return console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨ chartOtherOutSelf');
//
//     const chart = echarts.init(chartDom);
//     chartInstances.otherOutSelfChart = chart;
//     chart.showLoading();
//
//     // è®¾ç½®é»˜è®¤éšè—è¡¨æ ¼çŠ¶æ€
//     let lastClickedParams = null;  // ç”¨äºä¿å­˜ä¸Šæ¬¡ç‚¹å‡»çš„æŸ±çŠ¶å›¾ä¿¡æ¯
//
//     $.ajax({
//
//         type: 'GET',
//         dataType: 'json',
//         data: getQueryParams(),
//         success: function(response) {
//             if (!response.status) return showError(chart, response.error || 'åŠ è½½æ•°æ®å¤±è´¥');
//
//             // è®¡ç®—æ¯ä¸ªæ—¥æœŸä¸‹çš„æŸ±å­æ•°é‡å’Œä½ç½®
//             const barGap = '20%'; // æŸ±å­é—´è·
//             const barCategoryGap = '30%'; // ç±»ç›®é—´è·
//             const barWidth = Math.max(20, 80 / response.data.admins.length); // åŠ¨æ€å®½åº¦
//
//             const option = {
//                 tooltip: {
//                     trigger: 'item', // **ä¿®æ”¹ç‚¹1**: å°† 'axis' æ”¹ä¸º 'item'ï¼Œä½¿tooltipåªåœ¨æ‚¬åœåœ¨æŸä¸ªæŸ±çŠ¶å›¾ä¸Šæ—¶æ˜¾ç¤º
//                     axisPointer: { type: 'shadow' },
//                     formatter: function(params) {
//                         const date = params.name; // å½“å‰æŸ±çŠ¶å›¾çš„æ—¥æœŸ
//                         const admin = params.seriesName; // å½“å‰æŸ±çŠ¶å›¾çš„ç®¡ç†å‘˜
//                         const data = response.data.tooltip_data[date]?.[admin] || {}; // è·å–å¯¹åº”æ—¥æœŸå’Œç®¡ç†å‘˜çš„æ•°æ®
//
//                         let html = `<div style="font-weight:bold;margin-bottom:8px;border-bottom:1px solid #eee;padding-bottom:5px">
//                             ${date} å¤–éƒ¨å…¥åœˆè®¢å•</div>`;
//
//                         html += `<div style="margin:8px 0;padding-bottom:8px;border-bottom:1px dashed #eee">
//                             <div style="display:flex;align-items:center">
//                                 <span style="display:inline-block;width:12px;height:12px;background:${params.color};margin-right:8px;"></span>
//                                 <strong>${admin}</strong>
//                             </div>
//                             <div style="margin-left:20px;margin-top:5px;color:#555">
//                                 <div>è®¢å•æ•°: <b>${data.order_count || 0}ç¬”</b></div>
//                                 <div>åŸä»·æ€»è®¡: ${(data.original_amount || 0).toFixed(2)}å…ƒ</div>
//                                 <div style="color:#1890ff">åº”ä»˜æ¬¾: ${(data.payment+data.cross_fee || 0).toFixed(2)}å…ƒ</div>
//                                 <div style="color:#ff4d4f">è·¨åœˆè´¹: ${(data.cross_fee || 0).toFixed(2)}å…ƒ</div>
//                             </div>
//                         </div>`;
//                         return html;
//                     }
//                 },
//                 legend: {
//                     data: response.data.admins,
//                     type: 'scroll',
//                     bottom: 0
//                 },
//                 grid: {
//                     left: '3%',
//                     right: '4%',
//                     bottom: '15%',
//                     containLabel: true
//                 },
//                 xAxis: {
//                     type: 'category',
//                     data: response.data.dates,
//                     axisLabel: { rotate: 30, interval: 0 },
//                     axisPointer: {
//                         type: 'shadow'
//                     }
//                 },
//                 yAxis: {
//                     type: 'value',
//                     name: 'åº”ä»˜æ¬¾é‡‘é¢(å…ƒ)',
//                     axisLine: { show: true }
//                 },
//                 series: response.data.series.map(series => ({
//                     ...series,
//                     barWidth: barWidth,
//                     barGap: barGap,
//                     barCategoryGap: barCategoryGap
//                 }))
//             };
//
//             chart.setOption(option);
//             chart.hideLoading();
//
//             // ç‚¹å‡»äº‹ä»¶ï¼ˆä¿æŒä¸å˜ï¼‰
//             chart.on('click', function(params) {
//                 const date = params.name;
//                 const admin = params.seriesName;
//                 const details = response.data.tooltip_data[date]?.[admin]?.orders || [];
//
//                 const $tbody = $('#otherOutSelfDetailsBody').empty();
//                 if (details.length === 0) {
//                     $tbody.append('<tr><td colspan="9" class="text-center">æ— è®¢å•è¯¦æƒ…</td></tr>');
//                 } else {
//                     details.forEach(item => {
//                         $tbody.append(`<tr>
//                             <td>${item.out_admin}</td>
//                             <td>${item.out_admin_type}</td>
//                             <td>${item.order_number}</td>
//                             <td>${item.original_amount.toFixed(2)}å…ƒ</td>
//                             <td>${item.final_price.toFixed(2)}å…ƒ</td>
//                             <td>${item.cross_fee.toFixed(2)}å…ƒ</td>
//                             <td>${item.consumer}</td>
//                             <td>${item.order_status}</td>
//                             <td>${item.time}</td>
//                         </tr>`);
//                     });
//                 }
//                // åˆ¤æ–­æ˜¯å¦ç‚¹å‡»äº†ç›¸åŒçš„æŸ±çŠ¶å›¾
//                 if (lastClickedParams && lastClickedParams.name === date && lastClickedParams.seriesName === admin) {
//                     // å¦‚æœæ˜¯åŒä¸€ä¸ªæŸ±çŠ¶å›¾ï¼Œåˆ‡æ¢è¡¨æ ¼æ˜¾ç¤ºçŠ¶æ€
//                     $("#otherOutSelfDetails").toggle();  // åˆ‡æ¢æ˜¾ç¤ºæˆ–éšè—è¡¨æ ¼
//                 } else {
//                     // å¦‚æœæ˜¯ä¸åŒçš„æŸ±çŠ¶å›¾ï¼Œæ˜¾ç¤ºè¡¨æ ¼
//                     $("#otherOutSelfDetails").show();  // æ˜¾ç¤ºè¡¨æ ¼
//                 }
//
//                 // æ›´æ–°æœ€åç‚¹å‡»çš„æŸ±çŠ¶å›¾ä¿¡æ¯
//                 lastClickedParams = { name: date, seriesName: admin };
//             });
//
//             setTimeout(() => chart.resize(), 100);
//         },
//         error: function(xhr) {
//             showError(chart, 'è¯·æ±‚å¤±è´¥: ' + xhr.statusText);
//         }
//     });
// }

</script>
{% endblock %}