{% extends 'layout.html' %}
{% load static %}

{% block css %}
<style>
    .chart-container {
        height: 400px;
        min-width: 300px;
    }
    .panel-heading .pull-right {
        margin-top: -5px;
    }
    .date-filter {
        margin-bottom: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 日期筛选表单 -->
     <!-- 日期筛选表单 -->
    <div class="left">
        <form method="get" class="form-inline" style="margin-bottom: 20px;">
            <!-- 隐藏字段保持当前date_field -->
            <input type="hidden" name="date_field" value="{{ request.GET.date_field|default:'created_time' }}">

            <!-- 时间字段选择 -->
            <div class="form-group">
                <label class="control-label">时间字段</label>
                <select name="date_field" class="form-control" style="width: 120px; margin-left: 5px;"
                        onchange="this.form.submit()">
                    <option value="created_time" {% if request.GET.date_field == 'created_time' %}selected{% endif %}>创建时间</option>
                    <option value="updated_time" {% if request.GET.date_field == 'updated_time' %}selected{% endif %}>更新时间</option>
                    <option value="finished_time" {% if request.GET.date_field == 'finished_time' %}selected{% endif %}>结束时间</option>
                </select>
            </div>

            <!-- 日期范围 -->
            <div class="form-group">
                <label class="control-label">开始日期</label>
                <input type="date" class="form-control" name="start_date"
                       value="{{ start_date }}">
            </div>

            <div class="form-group" style="margin-left: 10px;">
                <label class="control-label">结束日期</label>
                <input type="date" class="form-control" name="end_date"
                       value="{{ end_date }}">
            </div>

            <!-- 操作按钮 -->
            <div class="form-group" style="margin-left: 10px;">
                <button type="submit" class="btn btn-primary">筛选</button>
                <a href="?" class="btn btn-default" style="margin-left: 5px;">重置</a>
            </div>


            <!-- 快捷筛选（保持为链接但携带所有参数） -->
            <div class="form-group" style="margin-left: 20px;">
                <label class="control-label">快捷筛选</label>
                <!-- 近3天 - 不需要传递start_date和end_date，days_range会自动计算 -->
                <a href="?date_field={{ request.GET.date_field|default:'created_time' }}&days_range=3"
                   class="btn btn-default {% if request.GET.days_range == '3' %}active{% endif %}">近3天</a>
                <!-- 近一周 -->
                <a href="?date_field={{ request.GET.date_field|default:'created_time' }}&days_range=7"
                   class="btn btn-default {% if request.GET.days_range == '7' %}active{% endif %}">近一周</a>
                <!-- 近一月 -->
                <a href="?date_field={{ request.GET.date_field|default:'created_time' }}&days_range=30"
                   class="btn btn-default {% if request.GET.days_range == '30' %}active{% endif %}">近一月</a>
            </div>
        </form>
    </div>


    <!-- 第一行：交易流水 -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    交易流水趋势
                    <div class="pull-right">
                        <select id="barChartType" class="form-control input-sm" style="width:100px;">
                            <option value="bar">柱状图</option>
                            <option value="line">折线图</option>
                        </select>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="chartBar" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>


<!-- 消费者消费统计图表 -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    消费者消费统计
                    <div class="pull-right">
                        <select id="consumerChartType" class="form-control input-sm" style="width:100px;">
                            <option value="bar">柱状图</option>
                            <option value="line">折线图</option>
                        </select>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="chartConsumer" class="chart-container"></div>
                    <table id="consumerTable" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>消费者</th>
                                <th>订单数</th>
                                <th>消费金额</th>
                                <th>实际支付</th>
                            </tr>
                        </thead>
                        <tbody id="consumerTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- 第二行：三个饼图 -->
    <div class="row">
        <div class="col-md-4">
            <div class="panel panel-default">
                <div class="panel-heading">跨圈借调分布</div>
                <div class="panel-body">
                    <div id="chartPieCross" class="chart-container"></div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block js %}
<script src="{% static 'js/echarts.js' %}"></script>
<script>
// 全局图表实例
var chartInstances = {};

// 初始化所有图表
function initCharts() {
    initBarChart();
    initConsumerChart();  // 新增




    // 监听窗口变化自动调整图表大小
    $(window).on('resize', function() {
        $.each(chartInstances, function(_, chart) {
            chart.resize();
        });
    });
}

// 获取查询参数
function getQueryParams() {
    return {
        date_field: $('[name="date_field"]').val(),
        start_date: $('[name="start_date"]').val(),
        end_date: $('[name="end_date"]').val()
    };
}

// 显示加载动画
function showLoading(chart) {
    chart.showLoading('default', {
        text: '数据加载中...',
        color: '#c23531',
        textColor: '#333',
        maskColor: 'rgba(255, 255, 255, 0.8)',
        zlevel: 0
    });
}

// 隐藏加载动画
function hideLoading(chart) {
    chart.hideLoading();
}

// 显示错误信息
function showError(chart, message) {
    chart.setOption({
        graphic: {
            elements: [{
                type: 'text',
                left: 'center',
                top: 'middle',
                style: {
                    text: message,
                    fontSize: 16,
                    fontWeight: 'bold',
                    fill: '#ff4d4f'
                }
            }]
        }
    });
}

// 初始化页面
$(document).ready(function() {
    initCharts();

    // 表单提交时刷新图表
    $('form').on('submit', function(e) {
        e.preventDefault();
        initCharts();
        return false;
    });
});



function initBarChart() {
    const chartDom = document.getElementById('chartBar');
    if (!chartDom) {
        console.error('错误: 找不到图表容器 #chartBar');
        return;
    }
    chartInstances.barChart = echarts.init(chartDom);

    // 初始化默认配置
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' }
        },
        legend: {
            data: [] // 初始为空，从后端获取
        },
        toolbox: {
                    feature: {
                        saveAsImage: {}
                    }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: [] // 初始为空，从后端获取
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: '{value} 元'
            }
        },
        series: [] // 初始为空，从后端获取
    };

    // 显示加载动画
    showLoading(chartInstances.barChart);

    // 使用AJAX获取数据
    $.ajax({
        url: '{% url "chart_bar" %}',
        type: 'GET',
        dataType: 'JSON',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chartInstances.barChart, response.error || '数据加载失败');

                return;
            }

            // 更新图表配置
            option.legend.data = response.data.series.map(item => item.name);
            option.xAxis.data = response.data.x_axis;
            option.series = response.data.series;

            // 设置图表选项
            chartInstances.barChart.setOption(option);
            hideLoading(chartInstances.barChart);
        },
        error: function(xhr, status, error) {
            showError(chartInstances.barChart, '数据加载失败: ' + error);
            console.log("完整错误响应:", xhr.responseText);
        // 然后你可以复制完整的错误信息
        },
        complete: function() {
            // 无论成功失败都隐藏加载动画（如果之前没隐藏）
            hideLoading(chartInstances.barChart);
        }
    });
}

    // 切换图表类型
    $('#barChartType').change(function() {
        const type = $(this).val();
        const option = chartInstances.barChart.getOption();
        option.series.forEach(series => {
            series.type = type;
        });
        chartInstances.barChart.setOption(option);
    });


// 初始化消费者详细图表
function initConsumerChart() {
    const chartDom = document.getElementById('chartConsumer');
    if (!chartDom) return;

    chartInstances.consumerDetailChart = echarts.init(chartDom);

    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: function(params) {
                let html = `<b>${params[0].axisValue}</b>`;
                params.forEach(param => {
                    html += `<br/>${param.marker} ${param.seriesName}: ${param.value}`;
                    if (param.seriesName.includes('金额')) {
                        html += ' 元';
                    }
                });
                html += '<br/><small>点击查看当日消费者详情</small>';
                return html;
            }
        },
        legend: {
            data: []
        },
        toolbox: {
            feature: {
                saveAsImage: {},
                magicType: {
                    type: ['line', 'bar']
                },
                dataView: { readOnly: true }
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: []
        },
        yAxis: [
            {
                type: 'value',
                name: '订单数',
                axisLabel: { formatter: '{value}' }
            },
            {
                type: 'value',
                name: '金额(元)',
                axisLabel: { formatter: '{value} 元' }
            }
        ],
        series: []
    };

    showLoading(chartInstances.consumerDetailChart);

    $.ajax({
        url: '{% url "chart_consumer" %}',
        type: 'GET',
        dataType: 'JSON',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                let errorDetail = response.error || '未知错误';
                if (response.detail) errorDetail += ` | ${response.detail}`;
                if (response.traceback) {
                    console.error("后端Traceback:", response.traceback);
                    errorDetail += ` (查看控制台获取详细堆栈)`;
                }

                showError(chartInstances.consumerDetailChart, '数据加载失败', errorDetail);
                return;
            }

            // 更新图表配置
            option.legend.data = response.data.series.map(item => item.name);
            option.xAxis.data = response.data.x_axis;

            // 配置双Y轴
            option.series = response.data.series.map((item, index) => {
                return {
                    ...item,
                    yAxisIndex: index === 0 ? 0 : 1  // 第一个系列用左Y轴，其他用右Y轴
                };
            });

            chartInstances.consumerDetailChart.setOption(option);
            hideLoading(chartInstances.consumerDetailChart);

            // 存储详细数据用于表格展示
            chartInstances.consumerDetailChart._detailData = response.data.details;

            // 添加点击事件
            chartInstances.consumerDetailChart.on('click', function(params) {
                showConsumerDetailTable(params.name);
            });
        },
        error: function(xhr, status, error) {
            let errorDetail = `HTTP状态: ${xhr.status}`;
            try {
                const errResponse = JSON.parse(xhr.responseText);
                if (errResponse.detail) errorDetail += ` | ${errResponse.detail}`;
                if (errResponse.traceback) {
                    console.error("后端Traceback:", errResponse.traceback);
                    errorDetail += ` (查看控制台获取详细堆栈)`;
                }
            } catch (e) {
                errorDetail += ` | ${xhr.responseText || '无详细错误信息'}`;
            }

            showError(chartInstances.consumerDetailChart, '请求失败: ' + error, errorDetail);
            console.error("完整错误响应:", xhr.responseText);
        },
        complete: function() {
            hideLoading(chartInstances.consumerDetailChart);
        }
    });
}

// 初始化消费者图表
function initConsumerChart() {
    var chartDom = document.getElementById('chartConsumer');
    if (!chartDom) {
        console.error('错误: 找不到图表容器 #chartConsumer');
        return;
    }

    var chart = echarts.init(chartDom);
    chartInstances.consumerChart = chart;

    var option = {
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        legend: { data: [] },
        toolbox: { feature: { saveAsImage: {} } },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: { type: 'category', data: [] },
        yAxis: [
            { type: 'value', name: '订单数' },
            { type: 'value', name: '金额(元)' }
        ],
        series: []
    };

    showLoading(chart);

    $.ajax({
        url: '{% url "chart_consumer" %}',
        type: 'GET',
        dataType: 'JSON',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chart, response.error || '数据加载失败');
                console.error("错误响应:", response);
                return;
            }

            option.legend.data = response.data.series.map(function(item) {
                return item.name;
            });
            option.xAxis.data = response.data.x_axis;
            option.series = response.data.series.map(function(item, index) {
                return {
                    ...item,
                    yAxisIndex: index === 0 ? 0 : 1
                };
            });

            chart.setOption(option);
            hideLoading(chart);

            // 存储消费者数据用于表格展示
            chart._consumerData = response.data.consumers;

            // 添加点击事件
            chart.on('click', function(params) {
                showConsumerTable(params.dataIndex);
            });
        },
        error: function(xhr) {
            showError(chart, '请求失败');
            console.error("请求错误:", xhr.responseText);
            hideLoading(chart);
        }
    });

    // 切换图表类型
    $('#consumerChartType').change(function() {
        var type = $(this).val();
        var option = chart.getOption();
        option.series.forEach(function(series) {
            series.type = type;
        });
        chart.setOption(option);
    });
}

// 显示消费者表格
function showConsumerTable(index) {
    var data = chartInstances.consumerChart._consumerData;
    if (!data || !data[index]) return;

    var $tableBody = $('#consumerTableBody');
    $tableBody.empty();

    data[index].forEach(function(consumer) {
        $tableBody.append(
            '<tr>' +
            '<td>' + consumer.username + '</td>' +
            '<td>' + consumer.order_count + '</td>' +
            '<td>' + consumer.total_amount.toFixed(2) + '</td>' +
            '<td>' + consumer.final_amount.toFixed(2) + '</td>' +
            '</tr>'
        );
    });

    $('#consumerTable').show();
}






</script>
{% endblock %}