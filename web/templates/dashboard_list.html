{% extends 'layout.html' %}
{% load static %}

{% block css %}
<style>
    .chart-container {
        height: 400px;
        min-width: 300px;
    }
    .panel-heading .pull-right {
        margin-top: -5px;
    }
    .date-filter {
        margin-bottom: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 4px;
    }


</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 日期筛选表单 -->
     {% include 'tag/time_filter.html' %}

{% if request.userinfo.usertype in "SUPERADMIN ADMIN" %}
    <!-- 第一行：交易流水 -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    交易流水趋势
                </div>
                <div class="panel-body">
                    <div id="chartBar" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

{% if request.userinfo.usertype in "SUPERADMIN ADMIN CUSTOMER" %}
<!-- 消费者消费统计图表 -->
    <div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">消费者消费金额统计</div>
            <div class="panel-body">
                <div id="chartConsumer" class="chart-container"></div>
                <div id="consumerDetails" style="margin-top: 20px; display: none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>消费者</th>
                                <th>订单号</th>
                                <th>订单原价</th>
                                <th>实际支付价格</th>
                                <th>折扣(%)</th>
                                <th>时间</th>
                            </tr>
                        </thead>
                        <tbody id="consumerDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
    {% endif %}

<div class="row">
    {% if request.userinfo.usertype in "SUPERADMIN ADMIN SUPPLIER" %}
    <!-- 供应商图表 -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">应结算供应商货款统计</div>
            <div class="panel-body">
                <div id="chartSupplier" style="height:400px;"></div>
                <div id="supplierDetails" class="mt-3" style="display:none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>供应商名称</th>
                                <th>订单号</th>
                                <th>订单原价</th>
                                <th>应付供应商账款金额</th>
                                <th>时间</th>
                            </tr>
                        </thead>
                        <tbody id="supplierDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
      {% endif %}

      {% if request.userinfo.usertype in "SUPERADMIN ADMIN SUPPORT" %}
    <!-- 客服图表 -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">应结算客服账款统计</div>
            <div class="panel-body">
                <div id="chartSupport" style="height:400px;"></div>
                <div id="supportDetails" class="mt-3" style="display:none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>客服名称</th>
                                <th>订单号</th>
                                <th>订单原价</th>
                                <th>客服垫付金额</th>
                                <th>提成</th>
                                <th>应付客服账款金额</th>
                                <th>时间</th>
                            </tr>
                        </thead>
                        <tbody id="supportDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}


    {% if request.userinfo.usertype in "SUPERADMIN ADMIN" %}
    <!-- 在dashboard_list.html的适当位置添加 -->
<div class="row">
    <!-- 本圈出库其他圈子订单 -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                本圈出库其他圈子订单
                <div class="pull-right">
                    <small>应收款统计</small>
                </div>
            </div>
            <div class="panel-body">
                <div id="chartSelfOutOther" class="chart-container" style="height:400px;"></div>
                <div id="selfOutOtherDetails" style="display:none;margin-top:20px">
                    <table class="table table-bordered table-hover">
                        <thead>
                        <tr>
                            <th>入库方管事人</th>
                            <th>类型</th>
                            <th>订单号</th>
                            <th>原价</th>
                            <th>实际支付价格</th>
                            <th>跨圈费</th>
                            <th>最终应收款</th>
                            <th>消费者</th>
                            <th>状态</th>
                            <th>时间</th>
                        </tr>
                        </thead>
                        <tbody id="selfOutOtherDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 其他圈子出库本圈订单 -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                其他圈子出库本圈订单
                <div class="pull-right">
                    <small>应付款统计</small>
                </div>
            </div>
            <div class="panel-body">
                <div id="chartOtherOutSelf" class="chart-container" style="height:400px;"></div>
                <div id="otherOutSelfDetails" style="display:none;margin-top:20px">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>出库方</th>
                                <th>类型</th>
                                <th>订单号</th>
                                <th>原价</th>
                                <th>实际支付价格</th>
                                <th>跨圈费</th>
                                <th>最终应支付</th>
                                <th>消费者</th>
                                <th>状态</th>
                                <th>时间</th>
                            </tr>
                        </thead>
                        <tbody id="otherOutSelfDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>
    {% endif %}

</div>
{% endblock %}

{% block js %}
<script src="{% static 'js/echarts.js' %}"></script>
<script>
// 全局图表实例
var chartInstances = {};

//初始化所有图表
function initCharts() {
    initBarChart();
    initConsumerChart();  // 新增
    initSupplierChart();  // 新增
    initSupportChart();   // 新增
    initOtherOutSelfChart();
    initSelfOutOtherChart();

    // 监听窗口变化自动调整图表大小
    $(window).on('resize', function() {
        $.each(chartInstances, function(_, chart) {
            chart.resize();
        });
    });
}

// 获取查询参数
function getQueryParams() {
    return {
        date_field: $('[name="date_field"]').val(),
        start_date: $('[name="start_date_str"]').val(),
        end_date: $('[name="end_date_str"]').val()
    };
}

//显示加载动画
function showLoading(chart) {
    chart.showLoading('default', {
        text: '数据加载中...',
        color: '#c23531',
        textColor: '#333',
        maskColor: 'rgba(255, 255, 255, 0.8)',
        zlevel: 0
    });
}

// 隐藏加载动画
function hideLoading(chart) {
    chart.hideLoading();
}

// 显示错误信息
function showError(chart, message) {
    chart.setOption({
        graphic: {
            elements: [{
                type: 'text',
                left: 'center',
                top: 'middle',
                style: {
                    text: message,
                    fontSize: 16,
                    fontWeight: 'bold',
                    fill: '#ff4d4f'
                }
            }]
        }
    });

    chart.hideLoading();

    // 清除现有内容
    chart.clear();

    // 添加错误提示
    chart.getDom().innerHTML += `
        <div class="echarts-error-message">
            <div style="font-size:16px;margin-bottom:10px">😢 图表加载失败</div>
            <div style="color:#666;font-size:14px">${message}</div>
        </div>
    `;

    console.error(`图表错误: ${message}`);
}

// 初始化页面
$(document).ready(function() {
    initCharts();

    // 表单提交时刷新图表
    $('form').on('submit', function(e) {
        e.preventDefault();
        initCharts();
        return false;
    });
});


function initBarChart() {
    const chartDom = document.getElementById('chartBar');
    if (!chartDom) return console.error('找不到图表容器 chartBar');

    const chart = echarts.init(chartDom);
    chartInstances.barChart = chart;
    chart.showLoading();

    $.ajax({
        url: '{% url "chart_bar" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) return showError(chart, response.error || '加载数据失败');

            const option = {
                title: {
                    text: `交易流水统计 (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const seriesName = params.seriesName;
                        const value = params.value;
                        const stats = response.data.total_stats;

                        let html = `<div style="font-weight:bold;margin-bottom:8px;">
                            ${response.data.date_range} 汇总数据</div>`;

                        html += `<div style="margin:5px 0;">
                            <span style="display:inline-block;width:12px;height:12px;
                                background:${params.color};margin-right:8px;"></span>
                            <strong>${seriesName}:</strong> ${value}
                            ${seriesName.includes('订单')? '笔' : '元'}
                        </div>`;

                        // 添加相关统计信息
                        if (seriesName === '总利润') {
                            html += `<div style="margin-top:10px;color:#555">
                                <div>总流水: ${stats.total_amount.toFixed(2)}元</div>
                                <div>系统费: ${stats.system_fee.toFixed(2)}元</div>
                                <div>三方借调费: ${stats.cross_fee.toFixed(2)}元</div>
                                <div>总支出: ${(stats.support_payment + stats.supplier_payment + stats.admin_payment).toFixed(2)}元</div>
                            </div>`;
                        }

                        return html;
                    }
                },
                legend: {
                    data: response.data.series.map(s => s.name),
                    bottom: 0,
                    // type:'scroll',
                    padding: [5, 50],
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                        saveAsImage: {}
                    }
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: { show: false }  // 隐藏日期标签，因为我们只显示一个汇总柱状图
                },
                yAxis: {
                    type: 'value',
                    // 在这里获取 seriesName，确保它在这个作用域内有定义
                    name: response.data.series.length > 0? (response.data.series[0].name.includes('订单')? '数量(笔)' : '金额(元)') : ''
                },
                series: response.data.series.map(s => ({
                   ...s,
                    barWidth: 60,  // 固定宽度
                    label: {
        show: true,
        position: 'top', // 数字显示在柱子顶部
        formatter: '{c}', // 只显示数值，可改为 '{c} 元' 带单位
        color: '#333', // 文字颜色
        fontSize: 12, // 字体大小
    }
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // 点击事件 - 显示所有订单详情
            chart.on('click', function(params) {
                const details = response.data.tooltip_data["汇总"] || [];

                const $tbody = $('#barChartDetailsBody').empty();
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="10" class="text-center">无订单详情</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`<tr>
                            <td>${item.order_number}</td>
                            <td>${item.out_admin}</td>
                            <td>${item.out_admin_type}</td>
                            <td>${item.original_amount.toFixed(2)}元</td>
                            <td>${item.final_price.toFixed(2)}元</td>
                            <td>${item.system_fee.toFixed(2)}元</td>
                            <td>${item.cross_fee.toFixed(2)}元</td>
                            <td><strong style="color:${item.profit >= 0? '#52c41a' : '#f5222d'}">
                                ${item.profit.toFixed(2)}元</strong></td>
                            <td>${item.consumer}</td>
                            <td>${item.time}</td>
                        </tr>`);
                    });
                }
                $("#barChartDetails").show();
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, '请求失败:'+ xhr.statusText);
        }
    });
}





// 修改后的消费者图表函数（完整版）
function initConsumerChart() {
    const chartDom = document.getElementById('chartConsumer');
    if (!chartDom) return console.error('找不到图表容器');

    const chart = echarts.init(chartDom);
    chartInstances.consumerChart = chart;
    chart.showLoading();

    // 保存上次点击的消费者名称
    let lastClickedConsumer = null;

    $.ajax({
        url: '{% url "chart_consumer" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) return showError(chart, response.error || '加载数据失败');

            const option = {
                title: {
                    text: `消费者消费统计 (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const consumer = params.seriesName;
                        const data = response.data.tooltip_data["汇总"][consumer] || {};

                        return `
                            <div style="font-weight:bold;margin-bottom:8px;">
                                ${response.data.date_range} 汇总数据
                            </div>
                            <div style="margin:8px 0;">
                                <span style="display:inline-block;width:12px;height:12px;
                                    background:${params.color};margin-right:8px;"></span>
                                <strong>${consumer}</strong>
                            </div>
                            <div style="margin-left:20px;color:#555">
                                <div>订单数: <b>${data.order_count || 0}笔</b></div>
                                <div style="color:#722ed1">消费金额总计: ${(data.total_consumption || 0).toFixed(2)}元</div>
                            </div>
                        `;
                    }
                },
                legend: {
                    data: response.data.consumers,
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: { rotate: 0 },
                    show: false,
                },
                yAxis: {
                    type: 'value',
                    name: '消费金额(元)'
                },
                series: response.data.series.map(series => ({
                    ...series,
                    barWidth: 40
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // 点击事件处理
            chart.on('click', function(params) {
                const currentConsumer = params.seriesName;
                const details = response.data.tooltip_data["汇总"][currentConsumer]?.orders || [];
                const $tbody = $('#consumerDetailsBody').empty();

                // 填充表格数据
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="6" class="text-center">无订单详情</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`
                            <tr>
                                <td>${currentConsumer}</td>
                                <td>${item.order_number}</td>
                                <td>${item.original_amount.toFixed(2)}元</td>
                                <td style="color:#ff4d4f; font-weight: bold">${item.final_price.toFixed(2)}元</td>
                                <td>${item.consumer_level}%</td>
                                <td>${item.created_time || '未知时间'}</td>
                            </tr>
                        `);
                    });
                }

                // 处理表格显示逻辑
                if (lastClickedConsumer === currentConsumer) {
                    // 点击的是同一个消费者，切换显示状态
                    $("#consumerDetails").toggle();
                } else {
                    // 点击的是不同消费者，显示新表格
                    $("#consumerDetails").show();
                    lastClickedConsumer = currentConsumer;
                }
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, '请求失败: ' + xhr.statusText);
        }
    });
}



// 修改后的供应商图表函数（完整版）
function initSupplierChart() {
    const chartDom = document.getElementById('chartSupplier');
    if (!chartDom) return console.error('找不到图表容器');

    const chart = echarts.init(chartDom);
    chartInstances.supplierChart = chart;
    chart.showLoading();

    // 保存上次点击的供应商名称
    let lastClickedSupplier = null;

    $.ajax({
        url: '{% url "chart_supplier" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) return showError(chart, response.error || '加载数据失败');

            const option = {
                title: {
                    text: `供应商结算统计 (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const supplier = params.seriesName;
                        const data = response.data.tooltip_data["汇总"][supplier] || {};

                        return `
                            <div style="font-weight:bold;margin-bottom:8px;">
                                ${response.data.date_range} 汇总数据
                            </div>
                            <div style="margin:8px 0;">
                                <span style="display:inline-block;width:12px;height:12px;
                                    background:${params.color};margin-right:8px;"></span>
                                <strong>${supplier}</strong>
                            </div>
                            <div style="margin-left:20px;color:#555">
                                <div>处理订单数: <b>${data.order_count || 0}笔</b></div>
                                <div style="color:#1890ff">结算金额总计: ${(data.total_payment || 0).toFixed(2)}元</div>
                            </div>
                        `;
                    }
                },
                legend: {
                    data: response.data.suppliers,
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: { rotate: 0 },
                    show: false,
                },
                yAxis: {
                    type: 'value',
                    name: '结算金额(元)'
                },
                series: response.data.series.map(series => ({
                    ...series,
                    barWidth: 40
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // 点击事件处理
            chart.on('click', function(params) {
                const currentSupplier = params.seriesName;
                const details = response.data.tooltip_data["汇总"][currentSupplier]?.orders || [];
                const $tbody = $('#supplierDetailsBody').empty();

                // 填充表格数据
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="5" class="text-center">无订单详情</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`
                            <tr>
                                <td>${currentSupplier}</td>
                                <td>${item.order_number}</td>
                                <td>${item.amount.toFixed(2)}元</td>
                                <td style="color:#ff4d4f; font-weight: bold">${item.payment.toFixed(2)}元</td>
                                <td>${item.created_time || '未知时间'}</td>
                            </tr>
                        `);
                    });
                }

                // 处理表格显示逻辑
                if (lastClickedSupplier === currentSupplier) {
                    // 点击的是同一个供应商，切换显示状态
                    $("#supplierDetails").toggle();
                } else {
                    // 点击的是不同供应商，显示新表格
                    $("#supplierDetails").show();
                    lastClickedSupplier = currentSupplier;
                }
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, '请求失败: ' + xhr.statusText);
        }
    });
}

//修改后的客服图表函数（完整版）
function initSupportChart() {
    const chartDom = document.getElementById('chartSupport');
    if (!chartDom) return console.error('找不到图表容器');

    const chart = echarts.init(chartDom);
    chartInstances.supportChart = chart;
    chart.showLoading();

    // 保存上次点击的客服名称
    let lastClickedSupport = null;

    $.ajax({
        url: '{% url "chart_support" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) return showError(chart, response.error || '加载数据失败');

            const option = {
                title: {
                    text: `客服统计 (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const support = params.seriesName;
                        const data = response.data.tooltip_data["汇总"][support] || {};

                        return `
                            <div style="font-weight:bold;margin-bottom:8px;">
                                ${response.data.date_range} 汇总数据
                            </div>
                            <div style="margin:8px 0;">
                                <span style="display:inline-block;width:12px;height:12px;
                                    background:${params.color};margin-right:8px;"></span>
                                <strong>${support}</strong>
                            </div>
                            <div style="margin-left:20px;color:#555">
                                <div>处理订单数: <b>${data.order_count || 0}笔</b></div>
                                <div>垫付金额总计: ${(data.support_payment || 0).toFixed(2)}元</div>
                                <div>提成金额总计: ${(data.commission || 0).toFixed(2)}元</div>
                                <div style="color:#ff4d4f">最终应支付金额总计: ${(data.final_support_payment || 0).toFixed(2)}元</div>
                            </div>
                        `;
                    }
                },
                legend: {
                    data: response.data.supports,
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: { rotate: 0 },
                    show: false,
                },
                yAxis: {
                    type: 'value',
                    name: '垫付金额(元)'
                },
                series: response.data.series.map(series => ({
                    ...series,
                    barWidth: 40
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // 点击事件处理
            chart.on('click', function(params) {
                const currentSupport = params.seriesName;
                const details = response.data.tooltip_data["汇总"][currentSupport]?.orders || [];
                const $tbody = $('#supportDetailsBody').empty();

                // 填充表格数据
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="6" class="text-center">无订单详情</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`
                            <tr>
                                <td>${currentSupport}</td>
                                <td>${item.order_number}</td>
                                <td>${item.amount.toFixed(2)}元</td>
                                <td style="font-weight: bold">${item.support_payment.toFixed(2)}元</td>
                                <td style="font-weight: bold">${item.commission.toFixed(2)}元</td>
                                <td style="color:rgba(255,77,79,0.93); font-weight: bold">${item.final_support_payment.toFixed(2)}元</td>
                                <td>${item.created_time || '未知时间'}</td>
                            </tr>
                        `);
                    });
                }

                // 处理表格显示逻辑
                if (lastClickedSupport === currentSupport) {
                    // 点击的是同一个客服，切换显示状态
                    $("#supportDetails").toggle();
                } else {
                    // 点击的是不同客服，显示新表格
                    $("#supportDetails").show();
                    lastClickedSupport = currentSupport;
                }
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, '请求失败: ' + xhr.statusText);
        }
    });
}


function initSelfOutOtherChart() {
    const chartDom = document.getElementById('chartSelfOutOther');
    if (!chartDom) return console.error('找不到图表容器 chartSelfOutOther');

    const chart = echarts.init(chartDom);
    chartInstances.selfOutOtherChart = chart;
    chart.showLoading();

    // 保存上次点击的信息
    let lastClickedAdmin = null;

    $.ajax({
        url: '{% url "chart_self_out_other" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) return showError(chart, response.error || '加载数据失败');

            const option = {
                title: {
                    text: `本圈出库订单统计 (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const admin = params.seriesName;
                        const data = response.data.tooltip_data["汇总"][admin] || {};

                        return `
                            <div style="font-weight:bold;margin-bottom:8px;">
                                ${response.data.date_range} 汇总数据
                            </div>
                            <div style="margin:8px 0;">
                                <span style="display:inline-block;width:12px;height:12px;
                                    background:${params.color};margin-right:8px;"></span>
                                <strong>${admin}</strong>
                            </div>
                            <div style="margin-left:20px;color:#555">
                                <div>总订单数: <b>${data.order_count || 0}笔</b></div>
                                <div>原价总计: ${(data.original_amount || 0).toFixed(2)}元</div>
                                <div>实际支付价格总计: ${(data.receivable || 0).toFixed(2)}元</div>
                                <div style="color:#ff4d4f">跨圈费总计: ${(data.cross_fee || 0).toFixed(2)}元</div>
                                <div style="color:#52c41a">应收款总计: ${(data.final_receivable || 0).toFixed(2)}元</div>
                            </div>
                        `;
                    }
                },
                legend: {
                    data: response.data.admins,
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: { rotate: 0 },
                    show: false,
                },
                yAxis: {
                    type: 'value',
                    name: '应收款金额(元)'
                },
                series: response.data.series.map(series => ({
                    ...series,
                    barWidth: 40
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // 点击事件处理
            chart.on('click', function(params) {
                const currentAdmin = params.seriesName;
                const details = response.data.tooltip_data["汇总"][currentAdmin]?.orders || [];
                const $tbody = $('#selfOutOtherDetailsBody').empty();

                // 填充表格数据
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="9" class="text-center">无订单详情</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`<tr>
                            <td>${item.in_admin}</td>
                            <td>${item.out_admin_type}</td>
                            <td>${item.order_number}</td>
                            <td>${item.original_amount.toFixed(2)}元</td>
                            <td>${item.receivable.toFixed(2)}元</td>
                            <td>${item.cross_fee.toFixed(2)}元</td>
<!--                            <td style="color:rgba(255,77,79,0.93)">${item.final_receivable.toFixed(2)}元</td>-->
                            <td><strong style="color:rgba(255,77,79,0.93)">${item.final_receivable.toFixed(2)}元</strong></td>
                            <td>${item.consumer}</td>
                            <td>${item.order_status}</td>
                            <td>${item.time}</td>
                        </tr>`);
                    });
                }

                // 处理表格显示逻辑
                if (lastClickedAdmin === currentAdmin) {
                    // 点击的是同一个管理员，切换显示状态
                    $("#selfOutOtherDetails").toggle();
                } else {
                    // 点击的是不同管理员，显示新表格
                    $("#selfOutOtherDetails").show();
                    lastClickedAdmin = currentAdmin;
                }
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, '请求失败: ' + xhr.statusText);
        }
    });
}


function initOtherOutSelfChart() {
    const chartDom = document.getElementById('chartOtherOutSelf');
    // 检查图表容器是否存在，如果不存在则打印错误信息并返回
    if (!chartDom) {
        return console.error('找不到图表容器 chartOtherOutSelf');
    }

    const chart = echarts.init(chartDom);
    chartInstances.otherOutSelfChart = chart;
    chart.showLoading();

    // 保存上次点击的管理员信息
    let lastClickedAdmin = null;

    $.ajax({
        url: '{% url "chart_other_out_self" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function (response) {
            // 如果请求数据失败，显示错误信息并返回
            if (!response.status) {
                return showError(chart, response.error || '加载数据失败');
            }

            // 构建 ECharts 图表的配置项
            const option = {
                title: {
                    text: `外部入圈订单统计 (${response.data.date_range})`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        const admin = params.seriesName;
                        const data = response.data.tooltip_data["汇总"][admin] || {};

                        return `
                            <div style="font-weight:bold;margin-bottom:8px;">
                                ${response.data.date_range} 汇总数据
                            </div>
                            <div style="margin:8px 0;">
                                <span style="display:inline-block;width:12px;height:12px;
                                    background:${params.color};margin-right:8px;"></span>
                                <strong>${admin}</strong>
                            </div>
                            <div style="margin-left:20px;color:#555">
                                <div>总订单数: <b>${data.order_count || 0}笔</b></div>
                                <div>原价总计: ${(data.original_amount || 0).toFixed(2)}元</div>
                                <div>实际支付价格总计: ${(data.payment || 0).toFixed(2)}元</div>
                                <div style="color:#ff4d4f">跨圈费总计: ${(data.cross_fee || 0).toFixed(2)}元</div>
                                <div style="color:#1890ff">应付款总计: ${(data.final_payment || 0).toFixed(2)}元</div>

                            </div>
                        `;
                    }
                },
                legend: {
                    data: response.data.admins,
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: {
                        rotate: 0,  // 不需要旋转
                        show: false  // 隐藏x轴标签（因为柱子内部已显示）
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '应付款金额(元)'
                },
                series: response.data.series.map(series => ({
                   ...series,
                    barWidth: 40,  // 固定宽度
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // 点击事件处理函数
            chart.on('click', function (params) {
                const admin = params.seriesName;
                const details = response.data.tooltip_data["汇总"][admin]?.orders || [];

                const $tbody = $('#otherOutSelfDetailsBody').empty();
                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="9" class="text-center">无订单详情</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`<tr>
                            <td>${item.out_admin}</td>
                            <td>${item.out_admin_type}</td>
                            <td>${item.order_number}</td>
                            <td>${item.original_amount.toFixed(2)}元</td>
                            <td>${item.payment.toFixed(2)}元</td>
                            <td>${item.cross_fee.toFixed(2)}元</td>
                            <td><strong style="color:rgba(255,77,79,0.93)">${item.final_payment.toFixed(2)}元</strong></td>
                            <td>${item.consumer}</td>
                            <td>${item.order_status}</td>
                            <td>${item.time}</td>
                        </tr>`);
                    });
                }
                // 处理表格显示逻辑
                if (lastClickedAdmin === admin) {
                    // 点击的是同一个管理员，切换显示状态
                    $("#otherOutSelfDetails").toggle();
                } else {
                    // 点击的是不同管理员，显示新表格
                    $("#otherOutSelfDetails").show();
                    lastClickedAdmin = admin;
                }
            });

            setTimeout(() => chart.resize(), 100);
        },
        error: function (xhr) {
            showError(chart, '请求失败:'+ xhr.statusText);
        }
    });
}


//初始化本圈出库其他圈子订单图表



// function initOtherOutSelfChart() {
//     const chartDom = document.getElementById('chartOtherOutSelf');
//     if (!chartDom) return console.error('找不到图表容器 chartOtherOutSelf');
//
//     const chart = echarts.init(chartDom);
//     chartInstances.otherOutSelfChart = chart;
//     chart.showLoading();
//
//     // 设置默认隐藏表格状态
//     let lastClickedParams = null;  // 用于保存上次点击的柱状图信息
//
//     $.ajax({
//
//         type: 'GET',
//         dataType: 'json',
//         data: getQueryParams(),
//         success: function(response) {
//             if (!response.status) return showError(chart, response.error || '加载数据失败');
//
//             // 计算每个日期下的柱子数量和位置
//             const barGap = '20%'; // 柱子间距
//             const barCategoryGap = '30%'; // 类目间距
//             const barWidth = Math.max(20, 80 / response.data.admins.length); // 动态宽度
//
//             const option = {
//                 tooltip: {
//                     trigger: 'item', // **修改点1**: 将 'axis' 改为 'item'，使tooltip只在悬停在某个柱状图上时显示
//                     axisPointer: { type: 'shadow' },
//                     formatter: function(params) {
//                         const date = params.name; // 当前柱状图的日期
//                         const admin = params.seriesName; // 当前柱状图的管理员
//                         const data = response.data.tooltip_data[date]?.[admin] || {}; // 获取对应日期和管理员的数据
//
//                         let html = `<div style="font-weight:bold;margin-bottom:8px;border-bottom:1px solid #eee;padding-bottom:5px">
//                             ${date} 外部入圈订单</div>`;
//
//                         html += `<div style="margin:8px 0;padding-bottom:8px;border-bottom:1px dashed #eee">
//                             <div style="display:flex;align-items:center">
//                                 <span style="display:inline-block;width:12px;height:12px;background:${params.color};margin-right:8px;"></span>
//                                 <strong>${admin}</strong>
//                             </div>
//                             <div style="margin-left:20px;margin-top:5px;color:#555">
//                                 <div>订单数: <b>${data.order_count || 0}笔</b></div>
//                                 <div>原价总计: ${(data.original_amount || 0).toFixed(2)}元</div>
//                                 <div style="color:#1890ff">应付款: ${(data.payment+data.cross_fee || 0).toFixed(2)}元</div>
//                                 <div style="color:#ff4d4f">跨圈费: ${(data.cross_fee || 0).toFixed(2)}元</div>
//                             </div>
//                         </div>`;
//                         return html;
//                     }
//                 },
//                 legend: {
//                     data: response.data.admins,
//                     type: 'scroll',
//                     bottom: 0
//                 },
//                 grid: {
//                     left: '3%',
//                     right: '4%',
//                     bottom: '15%',
//                     containLabel: true
//                 },
//                 xAxis: {
//                     type: 'category',
//                     data: response.data.dates,
//                     axisLabel: { rotate: 30, interval: 0 },
//                     axisPointer: {
//                         type: 'shadow'
//                     }
//                 },
//                 yAxis: {
//                     type: 'value',
//                     name: '应付款金额(元)',
//                     axisLine: { show: true }
//                 },
//                 series: response.data.series.map(series => ({
//                     ...series,
//                     barWidth: barWidth,
//                     barGap: barGap,
//                     barCategoryGap: barCategoryGap
//                 }))
//             };
//
//             chart.setOption(option);
//             chart.hideLoading();
//
//             // 点击事件（保持不变）
//             chart.on('click', function(params) {
//                 const date = params.name;
//                 const admin = params.seriesName;
//                 const details = response.data.tooltip_data[date]?.[admin]?.orders || [];
//
//                 const $tbody = $('#otherOutSelfDetailsBody').empty();
//                 if (details.length === 0) {
//                     $tbody.append('<tr><td colspan="9" class="text-center">无订单详情</td></tr>');
//                 } else {
//                     details.forEach(item => {
//                         $tbody.append(`<tr>
//                             <td>${item.out_admin}</td>
//                             <td>${item.out_admin_type}</td>
//                             <td>${item.order_number}</td>
//                             <td>${item.original_amount.toFixed(2)}元</td>
//                             <td>${item.final_price.toFixed(2)}元</td>
//                             <td>${item.cross_fee.toFixed(2)}元</td>
//                             <td>${item.consumer}</td>
//                             <td>${item.order_status}</td>
//                             <td>${item.time}</td>
//                         </tr>`);
//                     });
//                 }
//                // 判断是否点击了相同的柱状图
//                 if (lastClickedParams && lastClickedParams.name === date && lastClickedParams.seriesName === admin) {
//                     // 如果是同一个柱状图，切换表格显示状态
//                     $("#otherOutSelfDetails").toggle();  // 切换显示或隐藏表格
//                 } else {
//                     // 如果是不同的柱状图，显示表格
//                     $("#otherOutSelfDetails").show();  // 显示表格
//                 }
//
//                 // 更新最后点击的柱状图信息
//                 lastClickedParams = { name: date, seriesName: admin };
//             });
//
//             setTimeout(() => chart.resize(), 100);
//         },
//         error: function(xhr) {
//             showError(chart, '请求失败: ' + xhr.statusText);
//         }
//     });
// }

</script>
{% endblock %}