{% extends 'layout.html' %}
{% load static %}

{% block css %}
<style>
    .chart-container {
        height: 400px;
        min-width: 300px;
    }
    .panel-heading .pull-right {
        margin-top: -5px;
    }
    .date-filter {
        margin-bottom: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- æ—¥æœŸç­›é€‰è¡¨å• -->
     <!-- æ—¥æœŸç­›é€‰è¡¨å• -->
    <div class="left">
        <form method="get" class="form-inline" style="margin-bottom: 20px;">
            <!-- éšè—å­—æ®µä¿æŒå½“å‰date_field -->
            <input type="hidden" name="date_field" value="{{ request.GET.date_field|default:'created_time' }}">

            <!-- æ—¶é—´å­—æ®µé€‰æ‹© -->
            <div class="form-group">
                <label class="control-label">æ—¶é—´å­—æ®µ</label>
                <select name="date_field" class="form-control" style="width: 120px; margin-left: 5px;"
                        onchange="this.form.submit()">
                    <option value="created_time" {% if request.GET.date_field == 'created_time' %}selected{% endif %}>åˆ›å»ºæ—¶é—´</option>
                    <option value="updated_time" {% if request.GET.date_field == 'updated_time' %}selected{% endif %}>æ›´æ–°æ—¶é—´</option>
                    <option value="finished_time" {% if request.GET.date_field == 'finished_time' %}selected{% endif %}>ç»“æŸæ—¶é—´</option>
                </select>
            </div>

            <!-- æ—¥æœŸèŒƒå›´ -->
            <div class="form-group">
                <label class="control-label">å¼€å§‹æ—¥æœŸ</label>
                <input type="date" class="form-control" name="start_date"
                       value="{{ start_date }}">
            </div>

            <div class="form-group" style="margin-left: 10px;">
                <label class="control-label">ç»“æŸæ—¥æœŸ</label>
                <input type="date" class="form-control" name="end_date"
                       value="{{ end_date }}">
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="form-group" style="margin-left: 10px;">
                <button type="submit" class="btn btn-primary">ç­›é€‰</button>
                <a href="?" class="btn btn-default" style="margin-left: 5px;">é‡ç½®</a>
            </div>


            <!-- å¿«æ·ç­›é€‰ï¼ˆä¿æŒä¸ºé“¾æ¥ä½†æºå¸¦æ‰€æœ‰å‚æ•°ï¼‰ -->
            <div class="form-group" style="margin-left: 20px;">
                <label class="control-label">å¿«æ·ç­›é€‰</label>
                <!-- è¿‘3å¤© - ä¸éœ€è¦ä¼ é€’start_dateå’Œend_dateï¼Œdays_rangeä¼šè‡ªåŠ¨è®¡ç®— -->
                <a href="?date_field={{ request.GET.date_field|default:'created_time' }}&days_range=3"
                   class="btn btn-default {% if request.GET.days_range == '3' %}active{% endif %}">è¿‘3å¤©</a>
                <!-- è¿‘ä¸€å‘¨ -->
                <a href="?date_field={{ request.GET.date_field|default:'created_time' }}&days_range=7"
                   class="btn btn-default {% if request.GET.days_range == '7' %}active{% endif %}">è¿‘ä¸€å‘¨</a>
                <!-- è¿‘ä¸€æœˆ -->
                <a href="?date_field={{ request.GET.date_field|default:'created_time' }}&days_range=30"
                   class="btn btn-default {% if request.GET.days_range == '30' %}active{% endif %}">è¿‘ä¸€æœˆ</a>
            </div>
        </form>
    </div>


    <!-- ç¬¬ä¸€è¡Œï¼šäº¤æ˜“æµæ°´ -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    äº¤æ˜“æµæ°´è¶‹åŠ¿
                    <div class="pull-right">
                        <select id="barChartType" class="form-control input-sm" style="width:100px;">
                            <option value="bar">æŸ±çŠ¶å›¾</option>
                            <option value="line">æŠ˜çº¿å›¾</option>
                        </select>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="chartBar" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>


<!-- æ¶ˆè´¹è€…æ¶ˆè´¹ç»Ÿè®¡å›¾è¡¨ -->
    <div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">æ¶ˆè´¹è€…æ¶ˆè´¹ç»Ÿè®¡</div>
            <div class="panel-body">
                <div id="chartConsumer" class="chart-container"></div>
                <div id="orderDetails" style="margin-top: 20px; display: none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>æ¶ˆè´¹è€…</th>
                                <th>è®¢å•å·</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>å®Œæˆæ—¶é—´</th>
                                <th>è®¢å•é¢é¢</th>
                                <th>æŠ˜æ‰£(%)</th>
                                <th>å®é™…æ”¯ä»˜</th>
                            </tr>
                        </thead>
                        <tbody id="orderDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


  <div class="row">
    <!-- ä¾›åº”å•†å›¾è¡¨ -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">ä¾›åº”å•†ç»Ÿè®¡</div>
            <div class="panel-body">
                <div id="chartSupplier" style="height:400px;"></div>
                <div id="supplierDetails" class="mt-3" style="display:none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>ä¾›åº”å•†åç§°</th>
                                <th>è®¢å•å·</th>
                                <th>è®¢å•åŸä»·</th>
                                <th>åº”ä»˜ä¾›åº”å•†è´¦æ¬¾é‡‘é¢</th>
                            </tr>
                        </thead>
                        <tbody id="supplierDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- å®¢æœå›¾è¡¨ -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">å®¢æœç»Ÿè®¡</div>
            <div class="panel-body">
                <div id="chartSupport" style="height:400px;"></div>
                <div id="supportDetails" class="mt-3" style="display:none;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>å®¢æœåç§°</th>
                                <th>è®¢å•å·</th>
                                <th>è®¢å•åŸä»·</th>
                                <th>å®¢æœå«ä»˜é‡‘é¢</th>
                                <th>ææˆ</th>
                            </tr>
                        </thead>
                        <tbody id="supportDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


    <!-- åœ¨dashboard_list.htmlçš„é€‚å½“ä½ç½®æ·»åŠ  -->
<div class="row">
    <!-- å…¶ä»–åœˆå­å‡ºåº“æœ¬åœˆè®¢å• -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                å…¶ä»–åœˆå­å‡ºåº“æœ¬åœˆè®¢å•
                <div class="pull-right">
                    <small>åº”ä»˜æ¬¾ç»Ÿè®¡</small>
                </div>
            </div>
            <div class="panel-body">
                <div id="chartOtherOutSelf" class="chart-container" style="height:400px;"></div>
                <div id="otherOutSelfDetails" style="display:none;margin-top:20px">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>å‡ºåº“æ–¹</th>
                                <th>ç±»å‹</th>
                                <th>è®¢å•å·</th>
                                <th>åŸä»·</th>
                                <th>æœ€ç»ˆä»·</th>
                                <th>è·¨åœˆè´¹</th>
                                <th>æ¶ˆè´¹è€…</th>
                                <th>çŠ¶æ€</th>
                                <th>æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="otherOutSelfDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æœ¬åœˆå‡ºåº“å…¶ä»–åœˆå­è®¢å• -->
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                æœ¬åœˆå‡ºåº“å…¶ä»–åœˆå­è®¢å•
                <div class="pull-right">
                    <small>åº”æ”¶æ¬¾ç»Ÿè®¡</small>
                </div>
            </div>
            <div class="panel-body">
                <div id="chartSelfOutOther" class="chart-container" style="height:400px;"></div>
                <div id="selfOutOtherDetails" style="display:none;margin-top:20px">
                    <table class="table table-bordered table-hover">
                        <thead>
                        <tr>
                            <th>å…¥åº“æ–¹</th>
                            <th>ç±»å‹</th>
                            <th>è®¢å•å·</th>
                            <th>åŸä»·</th>
                            <th>æœ€ç»ˆä»·</th>
                            <th>è·¨åœˆè´¹</th>
                            <th>æ¶ˆè´¹è€…</th>
                            <th>çŠ¶æ€</th>
                            <th>æ—¶é—´</th>
                        </tr>
                        </thead>
                        <tbody id="selfOutOtherDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
{% endblock %}

{% block js %}
<script src="{% static 'js/echarts.js' %}"></script>
<script>
// å…¨å±€å›¾è¡¨å®ä¾‹
var chartInstances = {};

// åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
function initCharts() {
    initBarChart();
    initConsumerChart();  // æ–°å¢
    initSupplierChart();  // æ–°å¢
    initSupportChart();   // æ–°å¢
    initOtherOutSelfChart();
    initSelfOutOtherChart();

    // ç›‘å¬çª—å£å˜åŒ–è‡ªåŠ¨è°ƒæ•´å›¾è¡¨å¤§å°
    $(window).on('resize', function() {
        $.each(chartInstances, function(_, chart) {
            chart.resize();
        });
    });
}

// è·å–æŸ¥è¯¢å‚æ•°
function getQueryParams() {
    return {
        date_field: $('[name="date_field"]').val(),
        start_date: $('[name="start_date"]').val(),
        end_date: $('[name="end_date"]').val()
    };
}

//æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
function showLoading(chart) {
    chart.showLoading('default', {
        text: 'æ•°æ®åŠ è½½ä¸­...',
        color: '#c23531',
        textColor: '#333',
        maskColor: 'rgba(255, 255, 255, 0.8)',
        zlevel: 0
    });
}

// éšè—åŠ è½½åŠ¨ç”»
function hideLoading(chart) {
    chart.hideLoading();
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(chart, message) {
    chart.setOption({
        graphic: {
            elements: [{
                type: 'text',
                left: 'center',
                top: 'middle',
                style: {
                    text: message,
                    fontSize: 16,
                    fontWeight: 'bold',
                    fill: '#ff4d4f'
                }
            }]
        }
    });

    chart.hideLoading();

    // æ¸…é™¤ç°æœ‰å†…å®¹
    chart.clear();

    // æ·»åŠ é”™è¯¯æç¤º
    chart.getDom().innerHTML += `
        <div class="echarts-error-message">
            <div style="font-size:16px;margin-bottom:10px">ğŸ˜¢ å›¾è¡¨åŠ è½½å¤±è´¥</div>
            <div style="color:#666;font-size:14px">${message}</div>
        </div>
    `;

    console.error(`å›¾è¡¨é”™è¯¯: ${message}`);
}

// åˆå§‹åŒ–é¡µé¢
$(document).ready(function() {
    initCharts();

    // è¡¨å•æäº¤æ—¶åˆ·æ–°å›¾è¡¨
    $('form').on('submit', function(e) {
        e.preventDefault();
        initCharts();
        return false;
    });
});



function initBarChart() {
    const chartDom = document.getElementById('chartBar');
    if (!chartDom) {
        console.error('é”™è¯¯: æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨ #chartBar');
        return;
    }
    chartInstances.barChart = echarts.init(chartDom);

    // åˆå§‹åŒ–é»˜è®¤é…ç½®
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' }
        },
        legend: {
            data: [] // åˆå§‹ä¸ºç©ºï¼Œä»åç«¯è·å–
        },
        toolbox: {
                    feature: {
                        saveAsImage: {}
                    }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: [] // åˆå§‹ä¸ºç©ºï¼Œä»åç«¯è·å–
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: '{value} å…ƒ'
            }
        },
        series: [] // åˆå§‹ä¸ºç©ºï¼Œä»åç«¯è·å–
    };

    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    showLoading(chartInstances.barChart);

    // ä½¿ç”¨AJAXè·å–æ•°æ®
    $.ajax({
        url: '{% url "chart_bar" %}',
        type: 'GET',
        dataType: 'JSON',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chartInstances.barChart, response.error || 'æ•°æ®åŠ è½½å¤±è´¥');

                return;
            }

            // æ›´æ–°å›¾è¡¨é…ç½®
            option.legend.data = response.data.series.map(item => item.name);
            option.xAxis.data = response.data.x_axis;
            option.series = response.data.series;

            // è®¾ç½®å›¾è¡¨é€‰é¡¹
            chartInstances.barChart.setOption(option);
            hideLoading(chartInstances.barChart);
        },
        error: function(xhr, status, error) {
            showError(chartInstances.barChart, 'æ•°æ®åŠ è½½å¤±è´¥: ' + error);
            console.log("å®Œæ•´é”™è¯¯å“åº”:", xhr.responseText);
        // ç„¶åä½ å¯ä»¥å¤åˆ¶å®Œæ•´çš„é”™è¯¯ä¿¡æ¯
        },
        complete: function() {
            // æ— è®ºæˆåŠŸå¤±è´¥éƒ½éšè—åŠ è½½åŠ¨ç”»ï¼ˆå¦‚æœä¹‹å‰æ²¡éšè—ï¼‰
            hideLoading(chartInstances.barChart);
        }
    });
}

    // åˆ‡æ¢å›¾è¡¨ç±»å‹
    $('#barChartType').change(function() {
        const type = $(this).val();
        const option = chartInstances.barChart.getOption();
        option.series.forEach(series => {
            series.type = type;
        });
        chartInstances.barChart.setOption(option);
    });


function initConsumerChart() {
    const chartDom = document.getElementById('chartConsumer');
    if (!chartDom) return;

    const chart = echarts.init(chartDom);
    chartInstances.consumerChart = chart;

    showLoading(chart);

    $.ajax({
        url: '{% url "chart_consumer" %}',
        type: 'GET',
        dataType: 'JSON',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chart, response.error || 'æ•°æ®åŠ è½½å¤±è´¥');
                console.error("é”™è¯¯å“åº”:", response);
                return;
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {type: 'shadow'}
                },
                legend: {
                    data: response.data.series.map(item => item.name),
                    type: 'scroll',
                    orient: 'horizontal',
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.x_axis
                },
                yAxis: {
                    type: 'value',
                    name: 'å®é™…æ”¯ä»˜é‡‘é¢(å…ƒ)'
                },
                series: response.data.series
            };

            chart.setOption(option);
            hideLoading(chart);

            // å­˜å‚¨è®¢å•è¯¦æƒ…æ•°æ®
            chart._orderDetails = response.data.order_details;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            chart.on('click', function(params) {
                showOrderDetails(params);
            });
        },
        error: function(xhr) {
            showError(chart, 'è¯·æ±‚å¤±è´¥');
            console.error("è¯·æ±‚é”™è¯¯:", xhr.responseText);
            hideLoading(chart);
        }
    });
}

// æ˜¾ç¤ºæ¶ˆè´¹è€…è®¢å•è¯¦æƒ…
function showOrderDetails(params) {
    if (!params || !params.seriesName || !params.name) return;

    const details = chartInstances.consumerChart._orderDetails[params.name];
    if (!details) return;

    const $tbody = $('#orderDetailsBody');
    $tbody.empty();

    // è¿‡æ»¤å‡ºå½“å‰æ¶ˆè´¹è€…çš„è®¢å•
    const consumerOrders = details.filter(
        order => order.consumer === params.seriesName
    );

    consumerOrders.forEach(order => {
        const formatTime = (timeStr) => {
        if (!timeStr) return 'N/A';
        const date = new Date(timeStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).replace(/\//g, '-');
    };

        $tbody.append(`
            <tr>
                <td>${order.consumer}</td>
                <td>${order.order_number}</td>
                <td>${formatTime(order.created_time)}</td>
                <td>${formatTime(order.finished_time)}</td>
                <td>${order.amount.toFixed(2)}</td>
                <td>${order.discount}</td>
                <td>${order.final_price.toFixed(2)}</td>
            </tr>
        `);
    });

    $('#orderDetails').show();
}


// åˆå§‹åŒ–å®¢æœå›¾è¡¨ï¼ˆç²¾ç¡®ç‰ˆï¼‰
function initSupportChart() {
    const chartDom = document.getElementById('chartSupport');
    if (!chartDom) return;

    const chart = echarts.init(chartDom);
    chartInstances.supportChart = chart;

    showLoading(chart);

    $.ajax({
        url: '{% url "chart_support" %}',
        type: 'GET',
        dataType: 'JSON',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chart, response.error || 'æ•°æ®åŠ è½½å¤±è´¥');
                return;
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow',
                        shadowStyle: { color: 'rgba(0,0,0,0.05)' }
                    },
                    formatter: function(params) {
                        const date = params[0].axisValue;
                        const hoverData = response.data.tooltip_data[date] || {};

                        let html = `<div style="font-weight:bold;margin-bottom:8px">${date}</div>`;

                        params.forEach(param => {
                            const supportName = param.seriesName;
                            const data = hoverData[supportName];

                            if (!data) return '';

                            html += `
                                <div style="margin:8px 0;padding-bottom:8px;border-bottom:1px dashed #eee">
                                    <div style="display:flex;align-items:center">
                                        <span style="display:inline-block;
                                            width:12px;
                                            height:12px;
                                            background:${param.color};
                                            margin-right:8px;
                                            border-radius:2px">
                                        </span>
                                        <strong>${supportName}</strong>
                                    </div>
                                    <div style="margin-left:20px;margin-top:4px;color:#666">
                                        <div style="color:#ff4d4f">å«ä»˜é‡‘é¢: ${data.support_payment.toFixed(2)}å…ƒ</div>
                                        <div style="color:#52c41a">ææˆé‡‘é¢: ${data.commission.toFixed(2)}å…ƒ</div>
                                        <div>å¤„ç†è®¢å•æ•°: ${data.order_count}ç¬”</div>
                                    </div>
                                </div>
                            `;
                        });

                        return html;
                    }
                },
                legend: {
                    data: response.data.series.map(s => s.name),
                    type: 'scroll',
                    bottom: 0,
                    textStyle: { fontSize: 12 }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: {
                        rotate: 30,
                        fontSize: 12
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'å«ä»˜é‡‘é¢(å…ƒ)',
                    axisLine: { show: true }
                },
                series: response.data.series.map(series => ({
                    ...series,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        }
                    }
                }))
            };

            chart.setOption(option);
            hideLoading(chart);

            // å­˜å‚¨è¯¦æƒ…æ•°æ®
            chart._details = response.data.details;

            // ç‚¹å‡»äº‹ä»¶
            chart.on('click', function(params) {
                if (params.value === null) return;

                const date = params.name;
                const support = params.seriesName;
                const details = chart._details[date]?.[support] || [];

                const $tbody = $('#supportDetailsBody');
                $tbody.empty();

                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="6" class="text-center">æ— è®¢å•è¯¦æƒ…</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`
                            <tr>
                                <td>${support}</td>
                                <td>${item.order_number}</td>

                                <td>${item.amount.toFixed(2)}å…ƒ</td>
                                <td style="color:rgba(255,77,79,0.93)">${item.support_payment.toFixed(2)}å…ƒ</td>
                                <td style="color:#52c41a">${item.commission.toFixed(2)}å…ƒ</td>
                            </tr>
                        `);
                    });
                }

                $('#supportDetails').show();
            });
        },
        error: function(xhr) {
            showError(chart, 'è¯·æ±‚å¤±è´¥: ' + xhr.statusText);
            hideLoading(chart);
        }
    });
}


// åˆå§‹åŒ–ä¾›åº”å•†å›¾è¡¨ï¼ˆä¸å®¢æœå›¾è¡¨é€»è¾‘ç›¸åŒï¼Œä»…å­—æ®µä¸åŒï¼‰
// åˆå§‹åŒ–ä¾›åº”å•†å›¾è¡¨
function initSupplierChart() {
    const chartDom = document.getElementById('chartSupplier');
    if (!chartDom) return;

    const chart = echarts.init(chartDom);
    chartInstances.supplierChart = chart;

    showLoading(chart);

    $.ajax({
        url: '{% url "chart_supplier" %}',
        type: 'GET',
        dataType: 'JSON',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chart, response.error || 'æ•°æ®åŠ è½½å¤±è´¥');
                return;
            }



            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow',
                        shadowStyle: { color: 'rgba(0,0,0,0.05)' }
                    },
                    formatter: function(params) {
                        const date = params[0].axisValue;
                        const hoverData = response.data.tooltip_data[date] || {};

                        let html = `<div style="font-weight:bold;margin-bottom:8px">${date}</div>`;

                        params.forEach(param => {
                            const supplierName = param.seriesName;
                            const data = hoverData[supplierName];

                            if (!data) return '';

                            html += `
                                <div style="margin:8px 0;padding-bottom:8px;border-bottom:1px dashed #eee">
                                    <div style="display:flex;align-items:center">
                                        <span style="display:inline-block;
                                            width:12px;
                                            height:12px;
                                            background:${param.color};
                                            margin-right:8px;
                                            border-radius:2px">
                                        </span>
                                        <strong>${supplierName}</strong>
                                    </div>
                                    <div style="margin-left:20px;margin-top:4px;color:#666">
                                        <div>ç»“ç®—æ€»é¢: <b>${data.total.toFixed(2)}å…ƒ</b></div>
                                        <div>è®¢å•æ•°: ${data.order_count}ç¬”</div>
                                    </div>
                                </div>
                            `;
                        });

                        return html;
                    }
                },
                legend: {
                    data: response.data.series.map(s => s.name),
                    type: 'scroll',
                    bottom: 0,
                    textStyle: { fontSize: 12 }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: {
                        rotate: 30,
                        fontSize: 12
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'ç»“ç®—é‡‘é¢(å…ƒ)',
                    axisLine: { show: true }
                },
                series: response.data.series.map(series => ({
                    ...series,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                            // shadowColor: 'rgba(100,100,100,0.3)'
                        }
                    }

                }))
            };

            chart.setOption(option);
            hideLoading(chart);

            // å­˜å‚¨ç‚¹å‡»äº‹ä»¶æ‰€éœ€æ•°æ®
            chart._details = response.data.details;

            // ç‚¹å‡»äº‹ä»¶
            chart.on('click', function(params) {
                if (params.value === null) return;

                const date = params.name;
                const supplier = params.seriesName;
                const details = chart._details[date]?.[supplier] || [];

                const $tbody = $('#supplierDetailsBody');
                $tbody.empty();

                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="5" class="text-center">æ— è®¢å•è¯¦æƒ…</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`
                            <tr>
                                <td>${supplier}</td>
                                <td>${item.order_number}</td>

                                <td>${item.amount.toFixed(2)}å…ƒ</td>
                                <td>${item.payment.toFixed(2)}å…ƒ</td>
                            </tr>
                        `);
                    });
                }

                $('#supplierDetails').show();
            });
        },
        error: function(xhr) {
            showError(chart, 'è¯·æ±‚å¤±è´¥: ' + xhr.statusText);
            hideLoading(chart);
        }
    });
}


// âœ… é€šç”¨è¯¦æƒ…å±•ç¤ºå‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
function showDetails(type, params) {
    const chart = chartInstances[`${type}Chart`];
    if (!chart || !chart._details) return;

    const date = params.name;
    const name = params.seriesName;
    const details = chart._details[date]?.[name] || [];
    const tbodyId = `${type}DetailsBody`;
    const $tbody = $(`#${tbodyId}`);

    $tbody.empty();

    if (details.length === 0) {
        $tbody.append(`<tr><td colspan="6" class="text-center">æ— è®¢å•æ•°æ®</td></tr>`);
    } else {
        details.forEach(item => {
            $tbody.append(`
                <tr>
                    <td>${name}</td>
                    <td>${item.order_number}</td>
                    <td>${item.created_time || 'N/A'}</td>
                    <td>${item.amount.toFixed(2)}å…ƒ</td>
                    <td style="color:#ff4d4f">${item.payment.toFixed(2)}å…ƒ</td>
                    <td style="color:#52c41a">${item.commission.toFixed(2)}å…ƒ</td>
                </tr>
            `);
        });
    }

    $(`#${type}Details`).show();
}



// åˆå§‹åŒ–å…¶ä»–åœˆå­å‡ºåº“æœ¬åœˆè®¢å•å›¾è¡¨
function initOtherOutSelfChart() {
    const chartDom = document.getElementById('chartOtherOutSelf');
    if (!chartDom) {
        console.error('é”™è¯¯: æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨ chartOtherOutSelf');
        return;
    }

    const chart = echarts.init(chartDom);
    chartInstances.otherOutSelfChart = chart;

    chart.showLoading({
        text: 'æ­£åœ¨åŠ è½½æ•°æ®...',
        color: '#1890ff',
        textColor: '#333'
    });

    $.ajax({
        url: '{% url "chart_other_out_self" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chart, response.error || 'åŠ è½½æ•°æ®å¤±è´¥');
                return;
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        const date = params[0].axisValue;
                        const hoverData = response.data.tooltip_data[date] || {};

                        let html = `
                            <div style="font-weight:bold;margin-bottom:8px;border-bottom:1px solid #eee;padding-bottom:5px">
                                ${date} å¤–éƒ¨å…¥åœˆè®¢å•
                            </div>
                        `;

                        params.forEach(param => {
                            const admin = param.seriesName;
                            const data = hoverData[admin];

                            if (!data) return '';

                            html += `
                                <div style="margin:8px 0;padding-bottom:8px;border-bottom:1px dashed #eee">
                                    <div style="display:flex;align-items:center">
                                        <span style="display:inline-block;width:12px;height:12px;background:${param.color};margin-right:8px;"></span>
                                        <strong>${admin}</strong>
                                    </div>
                                    <div style="margin-left:20px;margin-top:5px;color:#555">
                                        <div>è®¢å•æ•°: <b>${data.order_count}ç¬”</b></div>
                                        <div>åŸä»·æ€»è®¡: ${data.original_amount.toFixed(2)}å…ƒ</div>
                                        <div style="color:#1890ff">åº”ä»˜æ¬¾: ${data.payment.toFixed(2)}å…ƒ</div>
                                        <div style="color:#ff4d4f">è·¨åœˆè´¹: ${data.cross_fee.toFixed(2)}å…ƒ</div>
                                    </div>
                                </div>
                            `;
                        });

                        return html;
                    }
                },
                legend: {
                    data: response.data.series.map(item => item.name),
                    type: 'scroll',
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: {
                        rotate: 30,
                        interval: 0
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'åº”ä»˜æ¬¾é‡‘é¢(å…ƒ)',
                    axisLine: {
                        show: true
                    }
                },
                series: response.data.series.map(item => ({
                    name: item.name,
                    type: 'bar',
                    barWidth: '60%',
                    data: item.data,
                    itemStyle: {
                        color: response.data.colors[item.name],
                        borderRadius: [4, 4, 0, 0]
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}å…ƒ'
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // å­˜å‚¨è¯¦æƒ…æ•°æ®
            chart._details = response.data.details || {};

            // ç‚¹å‡»äº‹ä»¶
            chart.on('click', function(params) {
                const date = params.name;
                const admin = params.seriesName;
                const details = chart._details[date]?.[admin] || [];

                const $tbody = $('#otherOutSelfDetailsBody');
                $tbody.empty();

                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="9" class="text-center">æ— è®¢å•è¯¦æƒ…</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`
                            <tr>
                                <td>${item.out_admin}</td>
                                <td>${item.out_admin_type}</td>
                                <td>${item.order_number}</td>
                                <td>${item.original_amount.toFixed(2)}å…ƒ</td>
                                <td>${item.final_price.toFixed(2)}å…ƒ</td>
                                <td>${item.cross_fee.toFixed(2)}å…ƒ</td>
                                <td>${item.consumer}</td>
                                <td>${item.order_status}</td>
                                <td>${item.time}</td>
                            </tr>
                        `);
                    });
                }

                $('#otherOutSelfDetails').show();
            });

            // å¼ºåˆ¶é‡ç»˜
            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, 'è¯·æ±‚å¤±è´¥: ' + xhr.statusText);
        }
    });
}

// é¡µé¢åŠ è½½åˆå§‹åŒ–
$(document).ready(function() {
    initOtherOutSelfChart();
});

// åˆå§‹åŒ–æœ¬åœˆå‡ºåº“å…¶ä»–åœˆå­è®¢å•å›¾è¡¨
function initSelfOutOtherChart() {
    const chartDom = document.getElementById('chartSelfOutOther');
    if (!chartDom) {
        console.error('é”™è¯¯: æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨ chartSelfOutOther');
        return;
    }

    const chart = echarts.init(chartDom);
    chartInstances.selfOutOtherChart = chart;

    chart.showLoading({
        text: 'æ­£åœ¨åŠ è½½æ•°æ®...',
        color: '#1890ff',
        textColor: '#333'
    });

    $.ajax({
        url: '{% url "chart_self_out_other" %}',
        type: 'GET',
        dataType: 'json',
        data: getQueryParams(),
        success: function(response) {
            if (!response.status) {
                showError(chart, response.error || 'åŠ è½½æ•°æ®å¤±è´¥');
                return;
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        const date = params[0].axisValue;
                        const hoverData = response.data.tooltip_data[date] || {};

                        let html = `
                            <div style="font-weight:bold;margin-bottom:8px;border-bottom:1px solid #eee;padding-bottom:5px">
                                ${date} æœ¬åœˆå‡ºåº“è®¢å•
                            </div>
                        `;

                        params.forEach(param => {
                            const admin = param.seriesName;
                            const data = hoverData[admin];

                            if (!data) return '';

                            html += `
                                <div style="margin:8px 0;padding-bottom:8px;border-bottom:1px dashed #eee">
                                    <div style="display:flex;align-items:center">
                                        <span style="display:inline-block;width:12px;height:12px;background:${param.color};margin-right:8px;"></span>
                                        <strong>${admin}</strong>
                                    </div>
                                    <div style="margin-left:20px;margin-top:5px;color:#555">
                                        <div>è®¢å•æ•°: <b>${data.order_count}ç¬”</b></div>
                                        <div>åŸä»·æ€»è®¡: ${data.original_amount.toFixed(2)}å…ƒ</div>
                                        <div style="color:#52c41a">åº”æ”¶æ¬¾: ${data.receivable.toFixed(2)}å…ƒ</div>
                                        <div style="color:#ff4d4f">è·¨åœˆè´¹: ${data.cross_fee.toFixed(2)}å…ƒ</div>
                                    </div>
                                </div>
                            `;
                        });

                        return html;
                    }
                },
                legend: {
                    data: response.data.series.map(item => item.name),
                    type: 'scroll',
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: response.data.dates,
                    axisLabel: {
                        rotate: 30,
                        interval: 0
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'åº”æ”¶æ¬¾é‡‘é¢(å…ƒ)',
                    axisLine: {
                        show: true
                    }
                },
                series: response.data.series.map(item => ({
                    name: item.name,
                    type: 'bar',
                    barWidth: '60%',
                    data: item.data,
                    itemStyle: {
                        color: response.data.colors[item.name],
                        borderRadius: [4, 4, 0, 0]
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}å…ƒ'
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }))
            };

            chart.setOption(option);
            chart.hideLoading();

            // å­˜å‚¨è¯¦æƒ…æ•°æ®
            chart._details = response.data.details || {};

            // ç‚¹å‡»äº‹ä»¶
            chart.on('click', function(params) {
                const date = params.name;
                const admin = params.seriesName;
                const details = chart._details[date]?.[admin] || [];

                const $tbody = $('#selfOutOtherDetailsBody');
                $tbody.empty();

                if (details.length === 0) {
                    $tbody.append('<tr><td colspan="9" class="text-center">æ— è®¢å•è¯¦æƒ…</td></tr>');
                } else {
                    details.forEach(item => {
                        $tbody.append(`
                            <tr>
                                <td>${item.in_admin}</td>
                                <td>${item.out_admin_type}</td>
                                <td>${item.order_number}</td>
                                <td>${item.original_amount.toFixed(2)}å…ƒ</td>
                                <td>${item.final_price.toFixed(2)}å…ƒ</td>
                                <td>${item.cross_fee.toFixed(2)}å…ƒ</td>
                                <td>${item.consumer}</td>
                                <td>${item.order_status}</td>
                                <td>${item.time}</td>
                            </tr>
                        `);
                    });
                }

                $('#selfOutOtherDetails').show();
            });

            // å¼ºåˆ¶é‡ç»˜
            setTimeout(() => chart.resize(), 100);
        },
        error: function(xhr) {
            showError(chart, 'è¯·æ±‚å¤±è´¥: ' + xhr.statusText);
        }
    });
}

// é¡µé¢åŠ è½½åˆå§‹åŒ–
$(document).ready(function() {
    initSelfOutOtherChart();
});



</script>
{% endblock %}