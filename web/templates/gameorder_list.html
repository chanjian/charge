{% extends 'layout.html' %}
{% load static %}
{% load permission %}

{% block content %}
    <div style="margin-bottom: 5px" class="clearfix">
        {% add_permission request 'gameorder_add'  %}

        <div class="right">
            <form class="form-inline" method="get">
                <div class="form-group">
                    <input name="keyword" type="text" class="form-control" placeholder="请输入关键字" value="{{ keyword }}">
                </div>
                <button type="submit" class="btn btn-default">
                    <span class="glyphicon glyphicon-search"></span>
                </button>
            </form>
        </div>
    </div>
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>ID</th>
            <th>充值系统</th>
            <th>游戏名称</th>
            <th>充值选项</th>
            <th>充值金额</th>
            <th>充值链接</th>
            <th>充值二维码</th>
            <th>订单消费者</th>
            <th>订单入库人</th>
            <th>订单号</th>
            <th>订单创建时间</th>
            <th>订单更新时间</th>
            <th>订单状态</th>
            {% if request|has_permission:"customer_edit,customer_delete" %}
            <th>操作</th>
            {% endif %}
        </tr>
        </thead>
        <tbody>
        {% for row in queryset %}
            <tr row-id="{{ row.id }}">
                <td>{{ row.id }}</td>
                <td>{{ row.platform }}</td>
                <td>{{ row.game }}</td>
                <td>{{ row.recharge_option }}</td>
                <td>{{ row.custom_amount }}</td>
                <!-- 充值链接（截断30字符+点击复制） -->
                <td class="copy-link" data-link="{{ row.recharge_link|default:'' }}">
                    {% if row.recharge_link %}
                        {{ row.recharge_link|truncatechars:30 }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <!-- 二维码（点击复制图片本身） -->
                <td class="copy-qrcode" data-url="\{{ row.qr_code }}">
                    {% if row.qr_code %}
                        <img src="\{{ row.qr_code }}" style="height: 80px;">
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ row.consumer }}</td>
                <td>{{ row.created_by}}</td>
                <td>{{ row.order_number }}</td>
                <td>{{ row.created_time|date:"Y-m-d H:i:s" }}</td>
                <td>{{ row.updated_time|date:"Y-m-d H:i:s" }}</td>
                <td>{{ row.get_order_status_display }}</td>
                {% if request|has_permission:"gameorder_edit,gameorder_delete" %}
                <td>
                    {% edit_permission request 'gameorder_edit' pk=row.id %}
                    {% delete_url_permission request 'gameorder_delete'  %}
                </td>
                {% endif %}
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <ul class="pagination">
        {{ pager_string }}
    </ul>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="alert alert-danger alert-dismissible fade in" role="alert">
                <h4>是否确定要删除！</h4>
                <p>此操作不可撤销，请谨慎操作。</p>
                <p>
                    <button type="button" class="btn btn-danger" id="btnConfirmDelete">确 定</button>
                    <button type="button" class="btn btn-default" id="btnCancelDelete">取 消</button>
                    <span style="color: red" id="deleteError"></span>
                </p>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
<script>
$(document).ready(function() {
    // =============== 1. 充值链接复制功能 ===============
    $('.copy-link').click(function() {
        var link = $(this).data('link');
        if (!link) return;

        // 创建临时元素实现复制
        var $temp = $('<input>');
        $('body').append($temp);
        $temp.val(link).select();
        document.execCommand('copy');
        $temp.remove();

        showToast('链接已复制');
    });

    // =============== 2. 二维码图片复制功能 ===============
    $('.copy-qrcode').click(function() {
        var imgUrl = $(this).data('url');
        if (!imgUrl) return;

        // 方案1：现代浏览器复制图片数据
        if (navigator.clipboard && window.ClipboardItem) {
            // 创建临时canvas
            var $canvas = $('<canvas>').css({position:'fixed',left:'-9999px'});
            var $img = $('<img>').attr('crossorigin', 'anonymous').attr('src', imgUrl);

            $('body').append($canvas).append($img);

            $img.on('load', function() {
                var canvas = $canvas[0];
                canvas.width = this.naturalWidth;
                canvas.height = this.naturalHeight;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(this, 0, 0);

                // 复制到剪贴板
                canvas.toBlob(function(blob) {
                    navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                    ]).then(function() {
                        showToast('二维码已复制到剪贴板');
                    }).catch(function(err) {
                        console.error("复制失败:", err);
                        fallbackCopy(imgUrl); // 降级方案
                    }).finally(function() {
                        $canvas.remove();
                        $img.remove();
                    });
                }, 'image/png');
            });

            $img.on('error', function() {
                showToast('图片加载失败');
                $canvas.remove();
                $img.remove();
            });
        } else {
            // 方案2：旧浏览器降级处理
            fallbackCopy(imgUrl);
        }
    });

    // 降级复制方案
    function fallbackCopy(imgUrl) {
        // 创建提示模态框
        var $modal = $('<div>').css({
            'position': 'fixed',
            'top': '0',
            'left': '0',
            'width': '100%',
            'height': '100%',
            'background': 'rgba(0,0,0,0.8)',
            'z-index': '9999',
            'text-align': 'center',
            'color': 'white',
            'padding-top': '20%'
        }).html(`
            <h4>您的浏览器不支持直接复制图片</h4>
            <p>请右键下方图片选择"复制图像"</p>
            <img src="${imgUrl}" style="max-width:80%; border:2px solid white; margin-top:20px;">
            <p style="margin-top:20px;"><button class="btn btn-default">关闭</button></p>
        `).click(function() {
            $(this).remove();
        });

        $('body').append($modal);
    }

    // =============== 3. 删除功能（保持不变） ===============
    var DELETE_ID;
    function bindDeleteEvent(){
        $('.btn-delete').click(function (){
            $("#deleteError").empty();
            $('#deleteModal').modal('show');
            DELETE_ID = $(this).attr('cid');
        });
        $('#btnCancelDelete').click(function (){
            $('#deleteModal').modal('hide');
        });
    }

    function bindConfirmDeleteEvent(){
        $('#btnConfirmDelete').click(function (){
           $.ajax({
               url:'{% url 'customer_delete' %}',
               type:'GET',
               data:{cid:DELETE_ID},
               dataType:'JSON',
               success:function (res){
                   if (res.status){
                       $("tr[row-id='" + DELETE_ID + "']").remove();
                       $('#deleteModal').modal('hide');
                   }else{
                       $("#deleteError").text(res.detail);
                   }
               }
           });
        });
    }

    bindDeleteEvent();
    bindConfirmDeleteEvent();

    // =============== 工具函数 ===============
    function showToast(message) {
        var $toast = $('<div>').text(message).css({
            'position': 'fixed',
            'bottom': '20px',
            'right': '20px',
            'background': '#4CAF50',
            'color': 'white',
            'padding': '10px 20px',
            'border-radius': '4px',
            'z-index': '9999'
        });
        $('body').append($toast);
        setTimeout(function() {
            $toast.fadeOut(function() {
                $(this).remove();
            });
        }, 2000);
    }
});
</script>

<style>
/* 可点击元素样式 */
.copy-link {
    cursor: pointer;
    border-bottom: 1px dashed #999;
    display: inline-block;
    max-width: 200px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.copy-qrcode {
    cursor: pointer;
    position: relative;
}
.copy-qrcode:hover img {
    opacity: 0.9;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
}

/* 表格样式微调 */
.table tbody tr td {
    vertical-align: middle !important;
}
</style>
{% endblock %}